<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <title>Diagn√≥stico API</title>
    <style>
        body {
            font-family: monospace;
            padding: 2rem;
            background: #f0f0f0;
        }

        .box {
            background: white;
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 1rem;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        h3 {
            margin-top: 0;
            border-bottom: 2px solid #ddd;
            padding-bottom: 0.5rem;
        }

        .success {
            color: green;
            font-weight: bold;
        }

        .error {
            color: red;
            font-weight: bold;
        }

        pre {
            background: #eee;
            padding: 10px;
            overflow: auto;
            max-height: 300px;
        }
    </style>
</head>

<body>
    <h1>Diagn√≥stico de Conexi√≥n ORDS</h1>
    <div id="config-info" class="box">Cargando configuraci√≥n...</div>
    <div id="results"></div>

    <script src="js/config.js"></script>
    <script>
        document.getElementById('config-info').innerHTML = `
            <h3>Configuraci√≥n</h3>
            <strong>API_BASE_URL:</strong> ${API_BASE_URL}<br>
            <em>(Esta es la URL a la que se intenta conectar)</em>
        `;

        async function testEndpoint(name, path) {
            const container = document.createElement('div');
            container.className = 'box';
            container.innerHTML = `<h3>Test: ${name} (${path})</h3><p>Conectando...</p>`;
            document.getElementById('results').appendChild(container);

            try {
                const start = Date.now();
                const res = await fetch(`${API_BASE_URL}${path}`);
                const duration = Date.now() - start;

                const statusColor = res.ok ? 'green' : 'red';
                let contentHTML = `<p><strong>Estado:</strong> <span style="color:${statusColor}">${res.status} ${res.statusText}</span> (${duration}ms)</p>`;

                try {
                    const json = await res.json();
                    contentHTML += `<strong>Respuesta JSON:</strong><pre>${JSON.stringify(json, null, 2)}</pre>`;

                    if (json.success === true) {
                        contentHTML += `<p class="success">‚úÖ Estructura 'success: true' CORRECTA.</p>`;
                        if (json.data) {
                            contentHTML += `<p>Datos recibidos: ${Array.isArray(json.data) ? json.data.length + ' items' : 'Objeto'}</p>`;
                        }
                    } else if (json.success === false) {
                        contentHTML += `<p class="error">‚ö†Ô∏è El servidor respondi√≥ 'success: false'</p>`;
                    } else {
                        contentHTML += `<p class="error">‚ùå FALTA campo 'success'. El formato no es compatible con la App.</p>`;
                    }

                } catch (e) {
                    contentHTML += `<p class="error">‚ùå No es JSON v√°lido.</p>`;
                    // Try text
                    try {
                        const text = await res.text(); // res.json() consumed body? no, create clone if executing twice, but here flow is rigorous
                        // Wait, request body is consumed. We can't read text if json failed usually unless we clone. 
                        // But fetch stream is locked. 
                        // Actually, res.json() fails, we can't read text easily from same object without clone.
                    } catch (err) { }

                }

                container.innerHTML = `<h3>Test: ${name} (${path})</h3>` + contentHTML;

            } catch (err) {
                container.innerHTML = `<h3>Test: ${name} (${path})</h3><p class="error">‚ùå Error de Red / Fetch: ${err.message}</p>`;
            }
        }

        async function runTests() {
            // Test all critical endpoints
            await testEndpoint('üìä Dashboard Stats', '/dashboard/stats');
            await testEndpoint('üë• Empleados (Employees)', '/employees');
            await testEndpoint('üè¢ Sucursales (Branches)', '/branches');
            await testEndpoint('‚ö†Ô∏è Incidencias (Incidents)', '/incidents');
            await testEndpoint('üìã Roster de Asistencia', '/attendance/roster');
        }

        // Add a summary at the top
        const summaryBox = document.createElement('div');
        summaryBox.className = 'box';
        summaryBox.style.background = '#fff3cd';
        summaryBox.innerHTML = `
            <h3>üîç Diagn√≥stico de Endpoints</h3>
            <p><strong>Objetivo:</strong> Verificar que todos los endpoints de Oracle ORDS est√°n configurados correctamente.</p>
            <p><strong>Qu√© buscar:</strong></p>
            <ul>
                <li>‚úÖ Estado HTTP 200 (OK)</li>
                <li>‚úÖ Respuesta JSON con estructura <code>{"success": true, "data": [...]}</code></li>
                <li>‚ùå Error 404 = Endpoint no existe en ORDS</li>
                <li>‚ùå Error CORS = Problema de permisos</li>
            </ul>
        `;
        document.getElementById('results').prepend(summaryBox);

        runTests();
    </script>
</body>

</html>