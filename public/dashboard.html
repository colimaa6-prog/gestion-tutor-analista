<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reporte de gestion - Dashboard</title>
    <link rel="icon" type="image/png" href="icon_app.png">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="css/toast.css">
    <style>
        /* Dashboard specific implementation - merge into style.css later */
        .dashboard-container {
            display: flex;
            height: 100vh;
            width: 100vw;
            background: rgba(255, 255, 255, 0.5);
            backdrop-filter: blur(10px);
        }

        .sidebar {
            width: 260px;
            background: rgba(255, 255, 255, 0.8);
            border-right: 1px solid var(--glass-border);
            padding: 2rem;
            display: flex;
            flex-direction: column;
        }

        .logo {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--primary-color);
            margin-bottom: 3rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .nav-links {
            list-style: none;
            flex: 1;
        }

        .nav-item {
            margin-bottom: 0.8rem;
        }

        .nav-link {
            display: flex;
            align-items: center;
            padding: 0.8rem 1rem;
            color: var(--text-light);
            text-decoration: none;
            border-radius: 12px;
            transition: all 0.3s ease;
            font-weight: 500;
        }

        .nav-link:hover,
        .nav-link.active {
            background: rgba(79, 70, 229, 0.1);
            color: var(--primary-color);
        }

        .user-profile {
            padding-top: 2rem;
            border-top: 1px solid #e2e8f0;
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .avatar {
            width: 40px;
            height: 40px;
            background: var(--primary-color);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
        }

        .main-content {
            flex: 1;
            padding: 2rem;
            overflow-y: auto;
        }

        .top-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
        }

        .page-title {
            font-size: 1.8rem;
            color: var(--text-color);
            font-weight: 600;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            background: white;
            padding: 1rem;
            border-radius: 12px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            border: 1px solid #f1f5f9;
        }

        .stat-label {
            color: var(--text-light);
            font-size: 0.8rem;
            margin-bottom: 0.4rem;
        }

        .stat-value {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--text-color);
        }
    </style>
</head>

<body>
    <div class="background-orb orb-1"></div>
    <div class="background-orb orb-2"></div>

    <div class="dashboard-container">
        <aside class="sidebar">
            <div class="logo">
                <img src="papel.png" alt="Logo" style="height: 40px; width: auto;"> Reporte de gestion
            </div>
            <ul class="nav-links">
                <li class="nav-item">
                    <a href="#" class="nav-link active" onclick="loadDashboard()">Dashboard</a>
                </li>
                <li class="nav-item">
                    <a href="#" class="nav-link" onclick="loadJefesOficina()">Jefes de Oficina</a>
                </li>
                <li class="nav-item">
                    <a href="#" class="nav-link" onclick="loadAsistencias()">Asistencias</a>
                </li>
                <li class="nav-item">
                    <a href="#" class="nav-link" onclick="loadIncidents()">Incidencias</a>
                </li>
                <li class="nav-item">
                    <a href="#" class="nav-link" onclick="loadReportes()">Reportes</a>
                </li>
            </ul>
            <div class="user-profile">
                <div class="avatar" id="userInitials">A</div>
                <div>
                    <div style="font-weight: 600; color: var(--text-color);" id="userName">Admin</div>
                    <div style="font-size: 0.8rem; color: var(--text-light);" id="userRole">Administrador</div>
                </div>
            </div>
        </aside>

        <main class="main-content">
            <div class="top-bar">
                <h2 class="page-title" id="pageTitle">Vista General</h2>

                <div style="display: flex; align-items: center; gap: 1rem;">
                    <!-- Alert Icon -->
                    <div id="alertIconContainer" onclick="openNotificationCenter()"
                        style="cursor: pointer; position: relative; margin-right: 5px;" title="Ver notificaciones">
                        <img src="alerta.png" alt="Alerta"
                            style="height: 32px; width: auto; filter: drop-shadow(0 2px 4px rgba(0,0,0,0.1));">
                        <span id="alertBadge"
                            style="position: absolute; top: -2px; right: -2px; background: #ef4444; color: white; border-radius: 50%; min-width: 18px; height: 18px; display: flex; align-items: center; justify-content: center; font-size: 11px; font-weight: bold; border: 2px solid white; box-shadow: 0 2px 4px rgba(0,0,0,0.2); display: none;">0</span>
                    </div>

                    <!-- Rotation Icon (Branch Changes) -->
                    <div id="rotationIconContainer" onclick="openBranchChangesPanel()"
                        style="cursor: pointer; position: relative; margin-right: 5px;"
                        title="Ver cambios en sucursales">
                        <img src="rotacion.png" alt="Rotaci√≥n"
                            style="height: 32px; width: auto; filter: drop-shadow(0 2px 4px rgba(0,0,0,0.1));">
                        <span id="rotationBadge"
                            style="position: absolute; top: -2px; right: -2px; background: #f59e0b; color: white; border-radius: 50%; min-width: 18px; height: 18px; display: flex; align-items: center; justify-content: center; font-size: 11px; font-weight: bold; border: 2px solid white; box-shadow: 0 2px 4px rgba(0,0,0,0.2); display: none;">0</span>
                    </div>

                    <div style="text-align: right;">
                        <div id="userDisplayName" style="font-weight: 500; color: #1e293b;"></div>
                        <div id="userRole" style="font-size: 0.85rem; color: #64748b;"></div>
                    </div>
                    <button onclick="logout()"
                        style="padding: 0.6rem 1.2rem; background: #ef4444; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 500; transition: background 0.2s;"
                        onmouseover="this.style.background='#dc2626'" onmouseout="this.style.background='#ef4444'">
                        Cerrar Sesi√≥n
                    </button>
                </div>
            </div>

            <div class="stats-grid" id="statsGrid">
                <div class="stat-card">
                    <div class="stat-label">Cargando...</div>
                    <div class="stat-value">-</div>
                </div>
            </div>

            <!-- Dynamic Content Area -->
            <div id="contentArea" style="width: 100%; overflow-x: auto;">
                <h3 style="margin-bottom: 1rem;">Bienvenido al Sistema de Gesti√≥n</h3>
                <p style="color: var(--text-light);">Selecciona una opci√≥n del men√∫ para comenzar.</p>
            </div>
        </main>
    </div>

    <script src="js/toast.js"></script>
    <script src="js/config.js"></script>
    <script>
        // Check auth
        const userStr = sessionStorage.getItem('user');
        if (!userStr) {
            window.location.href = 'index.html';
        } else {
            const user = JSON.parse(userStr);
            document.getElementById('userName').textContent = user.username;
            document.getElementById('userRole').textContent = user.role;
            document.getElementById('userInitials').textContent = user.username.charAt(0).toUpperCase();

            // Update top bar user info
            document.getElementById('userDisplayName').textContent = user.name || user.username;
            const roleLabels = {
                'admin': 'Administrador',
                'analista': 'Analista',
                'tutor': 'Tutor',
                'supervisor': 'Supervisor',
                'coordinador': 'Coordinador'
            };
            document.getElementById('userRole').textContent = roleLabels[user.role] || user.role;

            // Load dashboard data automatically on page load
            loadDashboard();

            // Start Alert Polling
            startAlertPolling();

            // Start Branch Changes Polling
            startBranchChangesPolling();
        }

        // Logout function
        function logout() {
            showConfirmToast('¬øEst√°s seguro de que deseas cerrar sesi√≥n?', () => {
                sessionStorage.removeItem('user');
                window.location.href = 'index.html';
            });
        }

        // Navigation Highlight
        function updateActiveLink(text) {
            document.querySelectorAll('.nav-link').forEach(link => {
                if (link.innerText === text) link.classList.add('active');
                else link.classList.remove('active');
            });
        }

        // --- GLOBAL STATE ---
        let currentYear = new Date().getFullYear();
        let currentMonth = new Date().getMonth(); // 0-11
        const monthNames = ["Enero", "Febrero", "Marzo", "Abril", "Mayo", "Junio", "Julio", "Agosto", "Septiembre", "Octubre", "Noviembre", "Diciembre"];

        async function loadDashboard() {
            updateActiveLink('Dashboard');
            document.getElementById('pageTitle').innerText = 'Vista General';
            document.getElementById('statsGrid').style.display = 'grid';

            // Load statistics
            await loadDashboardStats();

            // Check if user is admin
            const userStr = sessionStorage.getItem('user');
            const user = userStr ? JSON.parse(userStr) : null;
            const isAdmin = user && user.role === 'admin';
            const allowedAdmins = ['helder mora', 'esthfania ramos'];
            const canGenerateReports = isAdmin && allowedAdmins.includes(user.username?.toLowerCase());

            // Admin Reports Section (only for Helder Mora and Esthfania Ramos)
            const reportsSection = canGenerateReports ? `
                <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 2rem; border-radius: 16px; margin-bottom: 2rem; box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.2);">
                    <h3 style="color: white; margin: 0 0 1.5rem 0; font-size: 1.5rem; display: flex; align-items: center; gap: 0.5rem;">
                        <img src="reporte.png" alt="Reportes" style="height: 32px; width: auto;"> Reportes Administrativos
                    </h3>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 1rem;">
                        <button onclick="openTutorReportModal()" 
                                style="background: white; color: #667eea; padding: 1.25rem; border: none; border-radius: 12px; cursor: pointer; font-weight: 600; font-size: 1rem; transition: all 0.3s; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); display: flex; align-items: center; justify-content: center; gap: 0.5rem;"
                                onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 10px 15px -3px rgba(0, 0, 0, 0.2)';"
                                onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 6px -1px rgba(0, 0, 0, 0.1)';">
                            üë• Reporte de Tutores
                        </button>
                        <button onclick="openCollaboratorReportModal()" 
                                style="background: white; color: #8b5cf6; padding: 1.25rem; border: none; border-radius: 12px; cursor: pointer; font-weight: 600; font-size: 1rem; transition: all 0.3s; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); display: flex; align-items: center; justify-content: center; gap: 0.5rem;"
                                onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 10px 15px -3px rgba(0, 0, 0, 0.2)';"
                                onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 6px -1px rgba(0, 0, 0, 0.1)';">
                            üßë‚Äçüíº Reporte de Colaboradores
                        </button>
                        <button onclick="openAbsencesReportModal()" 
                                style="background: white; color: #dc2626; padding: 1.25rem; border: none; border-radius: 12px; cursor: pointer; font-weight: 600; font-size: 1rem; transition: all 0.3s; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); display: flex; align-items: center; justify-content: center; gap: 0.5rem;"
                                onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 10px 15px -3px rgba(0, 0, 0, 0.2)';"
                                onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 6px -1px rgba(0, 0, 0, 0.1)';">
                            ‚ùå Reporte de Faltas
                        </button>
                        <button onclick="openVacationsReportModal()" 
                                style="background: white; color: #3b82f6; padding: 1.25rem; border: none; border-radius: 12px; cursor: pointer; font-weight: 600; font-size: 1rem; transition: all 0.3s; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); display: flex; align-items: center; justify-content: center; gap: 0.5rem;"
                                onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 10px 15px -3px rgba(0, 0, 0, 0.2)';"
                                onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 6px -1px rgba(0, 0, 0, 0.1)';">
                            üèñÔ∏è Reporte de Vacaciones
                        </button>
                        <button onclick="openIncidentsReportModal()" 
                                style="background: white; color: #f59e0b; padding: 1.25rem; border: none; border-radius: 12px; cursor: pointer; font-weight: 600; font-size: 1rem; transition: all 0.3s; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); display: flex; align-items: center; justify-content: center; gap: 0.5rem;"
                                onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 10px 15px -3px rgba(0, 0, 0, 0.2)';"
                                onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 6px -1px rgba(0, 0, 0, 0.1)';">
                            ‚ö†Ô∏è Reporte de Incidencias
                        </button>
                    </div>
                </div>
            ` : '';

            // Load information boards
            document.getElementById('contentArea').innerHTML = `
                ${reportsSection}
                
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 1.5rem; margin-top: 2rem;">
                    <!-- Absences Board -->
                    <div class="info-board">
                        <h4 style="margin: 0 0 1rem 0; color: #ef4444; display: flex; align-items: center; gap: 0.5rem;">
                            <span>‚ùå</span> Colaboradores que Faltaron
                        </h4>
                        <div id="absencesBoard" style="max-height: 300px; overflow-y: auto;">
                            <p style="text-align: center; color: #94a3b8;">Cargando...</p>
                        </div>
                    </div>
                    
                    <!-- Vacations Board -->
                    <div class="info-board">
                        <h4 style="margin: 0 0 1rem 0; color: #3b82f6; display: flex; align-items: center; gap: 0.5rem;">
                            <span>üèñÔ∏è</span> Colaboradores de Vacaciones
                        </h4>
                        <div id="vacationsBoard" style="max-height: 300px; overflow-y: auto;">
                            <p style="text-align: center; color: #94a3b8;">Cargando...</p>
                        </div>
                    </div>
                    
                    <!-- Permissions Board -->
                    <div class="info-board">
                        <h4 style="margin: 0 0 1rem 0; color: #8b5cf6; display: flex; align-items: center; gap: 0.5rem;">
                            <span>üìã</span> Colaboradores con Permiso
                        </h4>
                        <div id="permissionsBoard" style="max-height: 300px; overflow-y: auto;">
                            <p style="text-align: center; color: #94a3b8;">Cargando...</p>
                        </div>
                    </div>
                    
                    <!-- Sick Leaves Board -->
                    <div class="info-board">
                        <h4 style="margin: 0 0 1rem 0; color: #f59e0b; display: flex; align-items: center; gap: 0.5rem;">
                            <span>üè•</span> Incapacidades Activas
                        </h4>
                        <div id="sickLeavesBoard" style="max-height: 300px; overflow-y: auto;">
                            <p style="text-align: center; color: #94a3b8;">Cargando...</p>
                        </div>
                    </div>
                    
                    <!-- Active Incidents Board -->
                    <div class="info-board" style="grid-column: span 2;">
                        <h4 style="margin: 0 0 1rem 0; color: #dc2626; display: flex; align-items: center; gap: 0.5rem;">
                            <span>‚ö†Ô∏è</span> Incidencias Activas
                        </h4>
                        <div id="incidentsBoard" style="max-height: 300px; overflow-y: auto;">
                            <p style="text-align: center; color: #94a3b8;">Cargando...</p>
                        </div>
                    </div>
                </div>
            `;

            // Add CSS for info boards
            if (!document.getElementById('infoBoardStyles')) {
                const style = document.createElement('style');
                style.id = 'infoBoardStyles';
                style.textContent = `
                    .info-board {
                        background: white;
                        padding: 1.5rem;
                        border-radius: 16px;
                        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
                        border: 1px solid #f1f5f9;
                    }
                    .info-item {
                        padding: 0.75rem;
                        border-bottom: 1px solid #f1f5f9;
                        transition: background 0.2s;
                    }
                    .info-item:hover {
                        background: #f8fafc;
                    }
                    .info-item:last-child {
                        border-bottom: none;
                    }
                `;
                document.head.appendChild(style);
            }

            // Load board data
            await loadDashboardBoards();

            // Auto-refresh every 5 minutes
            if (window.dashboardRefreshInterval) clearInterval(window.dashboardRefreshInterval);
            window.dashboardRefreshInterval = setInterval(() => {
                loadDashboardStats();
                loadDashboardBoards();
            }, 5 * 60 * 1000);
        }

        async function loadDashboardStats() {
            try {
                const userStr = sessionStorage.getItem('user');
                if (!userStr) return;
                const user = JSON.parse(userStr);

                const res = await fetch(`${API_BASE_URL}/dashboard/stats?userId=${user.id}`);
                const result = await res.json();

                if (result.success) {
                    const stats = result.data;
                    document.getElementById('statsGrid').innerHTML = `
                        <div class="stat-card">
                            <div class="stat-label">Asistencias</div>
                            <div class="stat-value" style="color: #22c55e;">${stats.asistencias}</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label">Faltas</div>
                            <div class="stat-value" style="color: #ef4444;">${stats.faltas}</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label">Vacaciones</div>
                            <div class="stat-value" style="color: #3b82f6;">${stats.vacaciones}</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label">Permisos</div>
                            <div class="stat-value" style="color: #8b5cf6;">${stats.permisos}</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label">Incapacidades</div>
                            <div class="stat-value" style="color: #f59e0b;">${stats.incapacidades}</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label">Incidencias Activas</div>
                            <div class="stat-value" style="color: #dc2626;">${stats.incidencias_activas}</div>
                        </div>
                    `;
                }
            } catch (e) {
                console.error('Error loading stats:', e);
            }
        }

        async function loadDashboardBoards() {
            const userStr = sessionStorage.getItem('user');
            if (!userStr) return;
            const user = JSON.parse(userStr);

            // Load absences
            try {
                const res = await fetch(`${API_BASE_URL}/dashboard/absences?userId=${user.id}`);
                const result = await res.json();
                const board = document.getElementById('absencesBoard');

                if (result.success && result.data.length > 0) {
                    board.innerHTML = result.data.map(emp => `
                        <div class="info-item">
                            <div style="font-weight: 500;">${emp.full_name}</div>
                            <div style="font-size: 0.85rem; color: #64748b;">${emp.branch_name || 'Sin sucursal'}</div>
                            ${emp.comment ? `<div style="font-size: 0.8rem; color: #94a3b8; margin-top: 0.25rem;">${emp.comment}</div>` : ''}
                        </div>
                    `).join('');
                } else {
                    board.innerHTML = '<p style="text-align: center; color: #94a3b8;">No hay faltas hoy</p>';
                }
            } catch (e) {
                console.error('Error loading absences:', e);
            }

            // Load vacations
            try {
                const res = await fetch(`${API_BASE_URL}/dashboard/vacations?userId=${user.id}`);
                const result = await res.json();
                const board = document.getElementById('vacationsBoard');

                if (result.success && result.data.length > 0) {
                    board.innerHTML = result.data.map(emp => `
                        <div class="info-item">
                            <div style="font-weight: 500;">${emp.full_name}</div>
                            <div style="font-size: 0.85rem; color: #64748b;">${emp.branch_name || 'Sin sucursal'}</div>
                            <div style="font-size: 0.8rem; color: #94a3b8; margin-top: 0.25rem;">
                                ${emp.start_date} ‚Üí ${emp.end_date}
                            </div>
                        </div>
                    `).join('');
                } else {
                    board.innerHTML = '<p style="text-align: center; color: #94a3b8;">No hay vacaciones activas</p>';
                }
            } catch (e) {
                console.error('Error loading vacations:', e);
            }

            // Load permissions
            try {
                const res = await fetch(`${API_BASE_URL}/dashboard/permissions?userId=${user.id}`);
                const result = await res.json();
                const board = document.getElementById('permissionsBoard');

                if (result.success && result.data.length > 0) {
                    board.innerHTML = result.data.map(emp => `
                        <div class="info-item">
                            <div style="font-weight: 500;">${emp.full_name}</div>
                            <div style="font-size: 0.85rem; color: #64748b;">${emp.branch_name || 'Sin sucursal'}</div>
                            <div style="font-size: 0.8rem; color: #94a3b8; margin-top: 0.25rem;">
                                ${emp.permission_type || 'Permiso'} | ${emp.start_date} ‚Üí ${emp.end_date}
                            </div>
                        </div>
                    `).join('');
                } else {
                    board.innerHTML = '<p style="text-align: center; color: #94a3b8;">No hay permisos activos</p>';
                }
            } catch (e) {
                console.error('Error loading permissions:', e);
            }

            // Load sick leaves
            try {
                const res = await fetch(`${API_BASE_URL}/dashboard/sick-leaves?userId=${user.id}`);
                const result = await res.json();
                const board = document.getElementById('sickLeavesBoard');

                if (result.success && result.data.length > 0) {
                    board.innerHTML = result.data.map(emp => `
                        <div class="info-item">
                            <div style="font-weight: 500;">${emp.full_name}</div>
                            <div style="font-size: 0.85rem; color: #64748b;">${emp.branch_name || 'Sin sucursal'}</div>
                            <div style="font-size: 0.8rem; color: #94a3b8; margin-top: 0.25rem;">
                                ${emp.start_date} ‚Üí ${emp.end_date}
                            </div>
                        </div>
                    `).join('');
                } else {
                    board.innerHTML = '<p style="text-align: center; color: #94a3b8;">No hay incapacidades activas</p>';
                }
            } catch (e) {
                console.error('Error loading sick leaves:', e);
            }

            // Load active incidents
            try {
                const res = await fetch(`${API_BASE_URL}/dashboard/active-incidents?userId=${user.id}`);
                const result = await res.json();
                const board = document.getElementById('incidentsBoard');

                if (result.success && result.data.length > 0) {
                    board.innerHTML = result.data.map(inc => `
                        <div class="info-item">
                            <div style="display: flex; justify-content: space-between; align-items: start;">
                                <div>
                                    <div style="font-weight: 500;">${inc.type}</div>
                                    <div style="font-size: 0.85rem; color: #64748b;">${inc.branch_name || 'Sin sucursal'} | Reportado por: ${inc.reported_by_name}</div>
                                    ${inc.description ? `<div style="font-size: 0.8rem; color: #94a3b8; margin-top: 0.25rem;">${inc.description}</div>` : ''}
                                </div>
                                <span style="padding: 0.25rem 0.75rem; background: ${inc.status === 'pending' ? '#fef3c7' : '#dbeafe'}; color: ${inc.status === 'pending' ? '#92400e' : '#1e40af'}; border-radius: 99px; font-size: 0.75rem;">${inc.status}</span>
                            </div>
                        </div>
                    `).join('');
                } else {
                    board.innerHTML = '<p style="text-align: center; color: #94a3b8;">No hay incidencias activas</p>';
                }
            } catch (e) {
                console.error('Error loading incidents:', e);
            }
        }

        // --- ATTENDANCE MODULE ---
        async function loadAsistencias() {
            updateActiveLink('Asistencias');
            document.getElementById('pageTitle').innerText = 'Control de Asistencias';
            document.getElementById('statsGrid').style.display = 'none';

            const daysInMonth = new Date(currentYear, currentMonth + 1, 0).getDate();

            // Iniciales de los d√≠as de la semana
            const dayInitials = ['D', 'L', 'M', 'M', 'J', 'V', 'S'];

            // Header: Month specific controls? For now just title + Add Button
            let gridHeader = '<th style="padding: 1rem; min-width: 200px; position: sticky; left: 0; background: white; z-index: 10;">Colaborador</th>';
            for (let i = 1; i <= daysInMonth; i++) {
                // Calcular el d√≠a de la semana (0 = Domingo, 6 = S√°bado)
                const date = new Date(currentYear, currentMonth, i);
                const dayOfWeek = date.getDay();
                const dayInitial = dayInitials[dayOfWeek];

                // Aplicar estilo gris para s√°bados (6) y domingos (0)
                const isWeekend = dayOfWeek === 0 || dayOfWeek === 6;
                const bgColor = isWeekend ? '#f1f5f9' : 'white';
                const textColor = isWeekend ? '#94a3b8' : '#64748b';

                gridHeader += `<th style="padding: 0.5rem; min-width: 40px; text-align: center; background: ${bgColor};">
                    <div style="font-size: 0.9rem; color: ${textColor}; font-weight: 600;">${i}</div>
                    <div style="font-size: 0.7rem; color: ${textColor}; margin-top: 2px;">${dayInitial}</div>
                </th>`;
            }

            const content = document.getElementById('contentArea');

            // Fetch archived months
            let archivedMonthsHTML = '';
            try {
                const userStr = sessionStorage.getItem('user');
                const user = userStr ? JSON.parse(userStr) : null;
                const userId = user ? user.id : '';
                const res = await fetch(`${API_BASE_URL}/attendance/archived-months?userId=${userId}`);
                const result = await res.json();

                if (result.success && result.data.length > 0) {
                    const today = new Date();
                    const currentMonthKey = `${today.getFullYear()}-${today.getMonth()}`;

                    // Filter out current month from archives
                    const archivedMonths = result.data.filter(m => `${m.year}-${m.month}` !== currentMonthKey);

                    if (archivedMonths.length > 0) {
                        archivedMonthsHTML = `
                            <div style="margin-bottom: 2rem;">
                                <h4 style="margin: 0 0 1rem 0; color: #64748b; font-size: 0.9rem; font-weight: 500; text-transform: uppercase; letter-spacing: 0.05em;">Meses Archivados</h4>
                                <div style="display: flex; gap: 1rem; overflow-x: auto; padding-bottom: 0.5rem;">
                                    ${archivedMonths.map(m => `
                                        <div onclick="loadMonthData(${m.month}, ${m.year})" 
                                             style="min-width: 140px; padding: 1rem 1.25rem; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); 
                                                    border-radius: 12px; cursor: pointer; transition: all 0.3s ease; 
                                                    box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);"
                                             onmouseover="this.style.transform='translateY(-2px) scale(1.02)'; this.style.boxShadow='0 10px 15px -3px rgba(0, 0, 0, 0.2)';"
                                             onmouseout="this.style.transform='translateY(0) scale(1)'; this.style.boxShadow='0 4px 6px -1px rgba(0, 0, 0, 0.1)';">
                                            <div style="color: white; font-weight: 600; font-size: 0.95rem; margin-bottom: 0.25rem;">${monthNames[m.month]}</div>
                                            <div style="color: rgba(255, 255, 255, 0.9); font-size: 0.85rem; margin-bottom: 0.5rem;">${m.year}</div>
                                            <div style="color: rgba(255, 255, 255, 0.8); font-size: 0.75rem; display: flex; align-items: center; gap: 0.25rem;">
                                                üìÅ ${m.record_count} registros
                                            </div>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                        `;
                    }
                }
            } catch (e) {
                console.error('Error loading archived months:', e);
            }

            // Check if viewing current month
            const today = new Date();
            const isCurrentMonth = (currentYear === today.getFullYear() && currentMonth === today.getMonth());

            const monthHeaderStyle = isCurrentMonth
                ? 'background: white; color: #1e293b; border: 2px solid #e2e8f0;'
                : 'background: white; color: #1e293b; border: 2px solid #e2e8f0;';

            const monthBadge = isCurrentMonth
                ? '<span style="background: #f1f5f9; color: #64748b; padding: 0.25rem 0.75rem; border-radius: 99px; font-size: 0.75rem; font-weight: 600;">MES ACTUAL</span>'
                : '<button onclick="loadCurrentMonth()" style="background: #f8fafc; border: 1px solid #cbd5e1; color: #475569; padding: 0.4rem 0.8rem; border-radius: 8px; font-size: 0.8rem; cursor: pointer; transition: all 0.2s;" onmouseover="this.style.background=\'#e2e8f0\'" onmouseout="this.style.background=\'#f8fafc\'">‚Üê Volver al Mes Actual</button>';

            content.innerHTML = `
                ${archivedMonthsHTML}
                
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; padding: 1.25rem; border-radius: 12px; ${monthHeaderStyle} box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);">
                    <div style="display: flex; align-items: center; gap: 1rem;">
                        <h3 style="margin: 0; font-size: 1.5rem; color: #1e293b;">${monthNames[currentMonth]} ${currentYear}</h3>
                        ${monthBadge}
                    </div>
                    
                    <!-- Branch Filter -->
                    <div style="flex: 1; display: flex; justify-content: center;">
                         <select id="attendanceBranchFilter" onchange="filterAttendanceTable()" style="padding: 0.6rem 1rem; border: 1px solid #cbd5e1; border-radius: 8px; min-width: 200px; color: #475569;">
                            <option value="">Todas las sucursales</option>
                        </select>
                    </div>

                    <button class="btn-primary" onclick="openAddRosterModal()" style="width: auto; padding: 0.6rem 1.2rem;">
                        + Agregar Colaborador
                    </button>
                </div>
                
                <div style="overflow-x: auto; max-width: 100%;">
                    <table style="border-collapse: collapse; min-width: 100%;">
                        <thead>
                            <tr style="border-bottom: 1px solid transparent;">${gridHeader}</tr>
                        </thead>
                        <tbody id="attendanceBody">
                            <tr><td colspan="${daysInMonth + 1}" style="padding: 2rem; text-align: center;">Cargando...</td></tr>
                        </tbody>
                    </table>
                </div>

                <!-- Detailed Attendance Form Modal -->
                <div id="attendanceFormModal" style="display: none; position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background: rgba(0,0,0,0.6); justify-content: center; align-items: center; z-index: 10000;">
                    <div style="background: white; padding: 2rem; border-radius: 16px; width: 500px; max-width: 90%; max-height: 90vh; overflow-y: auto; box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);">
                        <h3 style="margin-bottom: 1.5rem; color: #1e293b;">Registrar Asistencia</h3>
                        
                        <!-- Employee Name (Read-only) -->
                        <div style="margin-bottom: 1.5rem; padding: 1rem; background: #f8fafc; border-radius: 8px;">
                            <div style="font-size: 0.85rem; color: #64748b; margin-bottom: 0.25rem;">Colaborador</div>
                            <div id="formEmployeeName" style="font-weight: 600; color: #1e293b; font-size: 1.1rem;"></div>
                            <div id="formEmployeeBranch" style="font-size: 0.85rem; color: #64748b; margin-top: 0.25rem;"></div>
                        </div>

                        <!-- Status Selector -->
                        <div style="margin-bottom: 1.5rem;">
                            <label style="display: block; margin-bottom: 0.5rem; font-size: 0.9rem; color: #64748b; font-weight: 500;">Estatus</label>
                            <select id="formStatus" onchange="updateFormFields()" style="width: 100%; padding: 0.8rem; border: 1px solid #cbd5e1; border-radius: 8px; font-family: inherit; font-size: 1rem;">
                                <option value="">Seleccionar estatus...</option>
                                <option value="present">‚úÖ Asistencia</option>
                                <option value="delay">‚ö†Ô∏è Retardo</option>
                                <option value="absent">‚ùå Falta</option>
                                <option value="vacation">üèñÔ∏è Vacaciones</option>
                                <option value="permission">üìã Permiso</option>
                                <option value="incapacity">üè• Incapacidad</option>
                            </select>
                        </div>

                        <!-- Conditional Fields Container -->
                        <div id="conditionalFields" style="margin-bottom: 1.5rem;"></div>

                        <!-- Comment Field (Always visible) -->
                        <div style="margin-bottom: 1.5rem;">
                            <label style="display: block; margin-bottom: 0.5rem; font-size: 0.9rem; color: #64748b; font-weight: 500;">Comentario</label>
                            <textarea id="formComment" rows="3" placeholder="Agregar comentario (opcional)..." style="width: 100%; padding: 0.8rem; border: 1px solid #cbd5e1; border-radius: 8px; font-family: inherit; resize: vertical;"></textarea>
                        </div>

                        <!-- Action Buttons -->
                        <div style="display: flex; gap: 1rem; justify-content: flex-end;">
                            <button onclick="closeAttendanceForm()" style="padding: 0.8rem 1.5rem; border: 1px solid #cbd5e1; background: white; border-radius: 8px; cursor: pointer; font-family: inherit;">Cancelar</button>
                            <button onclick="saveAttendanceForm()" class="btn-primary" style="width: auto; padding: 0.8rem 1.5rem;">Guardar</button>
                        </div>
                    </div>
                </div>

            `;

            // Add Detail Modal HTML
            document.getElementById('contentArea').insertAdjacentHTML('beforeend', `
                <div id="attendanceDetailModal" style="display: none; position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background: rgba(0,0,0,0.6); justify-content: center; align-items: center; z-index: 10000;">
                    <div style="background: white; padding: 2rem; border-radius: 16px; width: 500px; max-width: 90%; max-height: 90vh; overflow-y: auto; box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);">
                        <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 1.5rem;">
                            <h3 style="margin: 0; color: #1e293b;">Detalle de Asistencia</h3>
                            <button onclick="closeAttendanceDetail()" style="background: none; border: none; font-size: 1.5rem; cursor: pointer; color: #64748b;">&times;</button>
                        </div>

                        <div style="margin-bottom: 1.5rem; padding: 1rem; background: #f8fafc; border-radius: 8px;">
                            <div style="font-size: 0.85rem; color: #64748b; margin-bottom: 0.25rem;">Colaborador</div>
                            <div id="detailEmployeeName" style="font-weight: 600; color: #1e293b; font-size: 1.1rem;"></div>
                            <div id="detailEmployeeBranch" style="font-size: 0.85rem; color: #64748b; margin-top: 0.25rem;"></div>
                        </div>

                        <div style="margin-bottom: 1.5rem;">
                            <label style="display: block; margin-bottom: 0.25rem; font-size: 0.85rem; color: #64748b; font-weight: 500;">Estatus</label>
                            <div id="detailStatus" style="font-size: 1.1rem; font-weight: 500; color: #0f172a;"></div>
                        </div>

                        <div id="detailConditionalFields" style="margin-bottom: 1.5rem;"></div>

                        <div style="margin-bottom: 1.5rem;">
                            <label style="display: block; margin-bottom: 0.25rem; font-size: 0.85rem; color: #64748b; font-weight: 500;">Comentario</label>
                            <div id="detailComment" style="padding: 1rem; background: #f1f5f9; border-radius: 8px; color: #334155; font-style: italic; min-height: 3rem;"></div>
                        </div>

                        <div style="display: flex; gap: 1rem; justify-content: flex-end; border-top: 1px solid #e2e8f0; padding-top: 1.5rem;">
                             <button onclick="closeAttendanceDetail()" style="padding: 0.8rem 1.5rem; border: 1px solid #cbd5e1; background: white; border-radius: 8px; cursor: pointer; font-family: inherit;">Cerrar</button>
                             <button title="Eliminar Registro" onclick="deleteAttendance()" style="padding: 0.8rem; border: 1px solid #fee2e2; background: #fef2f2; border-radius: 8px; cursor: pointer; color: #ef4444; margin-right: auto;">üóëÔ∏è</button>
                             <button onclick="switchToEditMode()" class="btn-primary" style="width: auto; padding: 0.8rem 1.5rem;">Editar Registro</button>
                        </div>
                    </div>
                </div>
            `);

            // Add Roster Modal HTML
            document.getElementById('contentArea').insertAdjacentHTML('beforeend', `
                <div id="rosterModal" style="display: none; position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background: rgba(0,0,0,0.6); justify-content: center; align-items: center; z-index: 10000;">
                    <div style="background: white; padding: 2rem; border-radius: 16px; width: 500px; max-width: 90%; max-height: 90vh; overflow-y: auto; box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);">
                        <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 1.5rem;">
                            <h3 style="margin: 0; color: #1e293b;">Agregar Colaborador</h3>
                            <button onclick="document.getElementById('rosterModal').style.display='none'" style="background: none; border: none; font-size: 1.5rem; cursor: pointer; color: #64748b;">&times;</button>
                        </div>
                        
                        <div style="margin-bottom: 1.5rem;">
                            <input type="text" id="rosterSearch" onkeyup="filterRosterOptions()" placeholder="Buscar colaborador..." style="width: 100%; padding: 0.8rem; border: 1px solid #cbd5e1; border-radius: 8px; font-family: inherit;">
                        </div>
                        
                        <div id="rosterList" style="max-height: 400px; overflow-y: auto; border: 1px solid #e2e8f0; border-radius: 8px;">
                            <p style="padding: 1rem; text-align: center; color: #94a3b8;">Cargando...</p>
                        </div>
                    </div>
                </div>
            `);

            fetchAndRenderAttendance();

            // Iniciar auto-refresco cada 30 segundos
            startAutoRefresh();
        }

        // Load specific month data
        function loadMonthData(month, year) {
            currentMonth = month;
            currentYear = year;
            loadAsistencias();
        }

        // Load current month
        function loadCurrentMonth() {
            const today = new Date();
            currentMonth = today.getMonth();
            currentYear = today.getFullYear();
            loadAsistencias();
        }


        async function deleteAttendance() {
            showConfirmToast('¬øEst√°s seguro de que deseas eliminar este registro de asistencia?', async () => {
                try {
                    await fetch(`${API_BASE_URL}/attendance/mark`, {
                        method: 'POST', // The endpoint uses POST to handle updates/deletes logic
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            employee_id: currentFormData.empId,
                            date: currentFormData.date,
                            status: 'none' // 'none' triggers deletion in server.js
                        })
                    });
                    closeAttendanceDetail();
                    fetchAndRenderAttendance();
                    showToast('Registro eliminado correctamente', 'success');
                } catch (e) {
                    console.error(e);
                    showToast('Error al eliminar', 'error');
                }
            });
        }

        let totalEmployees = []; // Store for search

        // Variable para el intervalo de auto-refresco
        let autoRefreshInterval = null;

        async function fetchAndRenderAttendance() {
            try {
                const userStr = sessionStorage.getItem('user');
                if (!userStr) return;
                const user = JSON.parse(userStr);

                const res = await fetch(`${API_BASE_URL}/attendance?month=${currentMonth}&year=${currentYear}&userId=${user.id}`);
                const result = await res.json();

                const tbody = document.getElementById('attendanceBody');
                if (!result.success || result.data.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="32" style="padding: 2rem; text-align: center; color: #64748b;">La lista est√° vac√≠a. A√±ade colaboradores manualmente.</td></tr>';
                    return;
                }

                const daysInMonth = new Date(currentYear, currentMonth + 1, 0).getDate();
                let html = '';
                const branches = new Set();

                // Map status to symbol
                const statusMap = {
                    'present': '‚úÖ', 'delay': '‚ö†Ô∏è', 'absent': '‚ùå', 'vacation': 'V', 'permission': 'P', 'incapacity': 'I'
                };

                result.data.forEach(emp => {
                    if (emp.branch_name) branches.add(emp.branch_name);

                    html += `<tr data-branch="${emp.branch_name || ''}">
                        <td style="padding: 0.8rem; position: sticky; left: 0; background: white; z-index: 5; box-shadow: 4px 0 8px -4px rgba(0,0,0,0.1);">
                            <div style="display: flex; justify-content: space-between; align-items: flex-start; gap: 0.5rem;">
                                <div>
                                    <div style="font-weight: 500;">${emp.full_name}</div>
                                    <div style="font-size: 0.75rem; color: #94a3b8;">${emp.branch_name || ''}</div>
                                </div>
                                <button onclick="removeFromRoster(${emp.id}, '${emp.full_name}')" title="Quitar de la lista" style="border: none; background: none; cursor: pointer; color: #cbd5e1; transition: color 0.2s;" onmouseover="this.style.color='#ef4444'" onmouseout="this.style.color='#cbd5e1'">
                                    üóëÔ∏è
                                </button>
                            </div>
                        </td>`;

                    for (let d = 1; d <= daysInMonth; d++) {
                        // Construct date key YYYY-MM-DD
                        const dStr = d < 10 ? `0${d}` : `${d}`;
                        const mStr = (currentMonth + 1) < 10 ? `0${currentMonth + 1}` : `${currentMonth + 1}`;
                        const dateKey = `${currentYear}-${mStr}-${dStr}`;

                        // Calcular si es fin de semana
                        const date = new Date(currentYear, currentMonth, d);
                        const dayOfWeek = date.getDay();
                        const isWeekend = dayOfWeek === 0 || dayOfWeek === 6;
                        const cellBgColor = isWeekend ? '#f8f9fa' : 'white';

                        const attendanceData = emp.marks[dateKey] || null;
                        const status = attendanceData ? attendanceData.status : '';
                        const display = statusMap[status] || '';
                        const hasComment = attendanceData && attendanceData.comment;

                        // Create tooltip text if there's a comment
                        const tooltipText = hasComment ? attendanceData.comment.replace(/"/g, '&quot;') : '';
                        const title = hasComment ? `title="${tooltipText}"` : '';

                        const content = display ?
                            `<div ${title} style="display: flex; justify-content: center; align-items: center; width: 30px; height: 30px; border: 1px solid rgba(59, 130, 246, 0.5); background: rgba(59, 130, 246, 0.05); border-radius: 8px; margin: 0 auto; position: relative;">
                                <span style="font-size: 1.1rem;">${display}</span>
                                ${hasComment ? '<div style="position: absolute; top: -3px; right: -3px; width: 8px; height: 8px; background-color: #22c55e; border-radius: 50%; box-shadow: 0 0 0 1px white;"></div>' : ''}
                             </div>` :
                            `<div style="width: 24px; height: 24px; background: rgba(203, 213, 225, 0.4); border-radius: 6px; margin: 0 auto; transition: background 0.2s;" onmouseover="this.style.background='rgba(148, 163, 184, 0.6)'" onmouseout="this.style.background='rgba(203, 213, 225, 0.4)'"></div>`;

                        html += `<td onclick="${display ? 'openAttendanceDetail' : 'openAttendanceForm'}(${display ? "{" + `status:'${status}', comment:'${attendanceData.comment ? attendanceData.comment.replace(/'/g, "\\'") : ''}', arrival_time:'${attendanceData.arrival_time || ''}', permission_type:'${attendanceData.permission_type || ''}', start_date:'${attendanceData.start_date || ''}', end_date:'${attendanceData.end_date || ''}', date:'${dateKey}'` + "}" : ""}${display ? `, ${emp.id}, '${emp.full_name}', '${emp.branch_name || ''}'` : `${emp.id}, '${emp.full_name}', '${emp.branch_name || ''}', '${dateKey}'`})" 
                                    style="text-align: center; cursor: pointer; user-select: none; position: relative; padding: 0.5rem; background: ${cellBgColor};">
                                    ${content}
                                 </td>`;
                    }
                    html += '</tr>';
                });
                tbody.innerHTML = html;

                // Populate Branch Filter
                const filterSelect = document.getElementById('attendanceBranchFilter');
                if (filterSelect) {
                    const currentVal = filterSelect.value;
                    filterSelect.innerHTML = '<option value="">Todas las sucursales</option>';
                    Array.from(branches).sort().forEach(b => {
                        const opt = document.createElement('option');
                        opt.value = b;
                        opt.textContent = b;
                        filterSelect.appendChild(opt);
                    });
                    filterSelect.value = currentVal;
                    filterAttendanceTable(); // Apply existing filter
                }

            } catch (e) { console.error(e); }
        }

        // Funci√≥n para iniciar auto-refresco
        function startAutoRefresh() {
            // Limpiar intervalo previo si existe
            if (autoRefreshInterval) {
                clearInterval(autoRefreshInterval);
            }
            // Refrescar cada 30 segundos
            autoRefreshInterval = setInterval(() => {
                fetchAndRenderAttendance();
            }, 30000);
        }

        // Funci√≥n para detener auto-refresco
        function stopAutoRefresh() {
            if (autoRefreshInterval) {
                clearInterval(autoRefreshInterval);
                autoRefreshInterval = null;
            }
        }

        function filterAttendanceTable() {
            const filter = document.getElementById('attendanceBranchFilter').value;
            const rows = document.querySelectorAll('#attendanceBody tr');
            rows.forEach(row => {
                const branch = row.getAttribute('data-branch');
                // show if no filter selected or branch matches
                if (!filter || branch === filter) {
                    row.style.display = '';
                } else {
                    row.style.display = 'none';
                }
            });
        }

        async function removeFromRoster(empId, empName) {
            showConfirmToast(`¬øEst√°s seguro de quitar a ${empName} de la lista de asistencia?`, async () => {
                try {
                    const res = await fetch(`${API_BASE_URL}/attendance/roster/${empId}`, { method: 'DELETE' });
                    const data = await res.json();
                    if (data.success) {
                        fetchAndRenderAttendance();
                        showToast(`${empName} eliminado de la lista`, 'success');
                    } else {
                        showToast('Error al eliminar: ' + (data.message || 'Desconocido'), 'error');
                    }
                } catch (e) {
                    showToast('Error de conexi√≥n al eliminar', 'error');
                }
            });
        }

        // --- Attendance Form Logic ---
        let currentFormData = { empId: null, empName: '', empBranch: '', date: null };
        let attendanceCache = {}; // Store fetched attendance data

        async function openAttendanceForm(empId, empName, empBranch, date) {
            currentFormData = { empId, empName, empBranch, date };

            // Populate employee info
            document.getElementById('formEmployeeName').textContent = empName;
            document.getElementById('formEmployeeBranch').textContent = empBranch;

            // Fetch existing attendance data for this employee/date
            try {
                const res = await fetch(`${API_BASE_URL}/attendance?month=${currentMonth}&year=${currentYear}`);
                const result = await res.json();

                if (result.success) {
                    const empData = result.data.find(e => e.id === empId);
                    const existingData = empData && empData.marks[date] ? empData.marks[date] : null;

                    // Populate form with existing data
                    if (existingData) {
                        document.getElementById('formStatus').value = existingData.status || '';
                        document.getElementById('formComment').value = existingData.comment || '';



                        // Store for conditional fields
                        attendanceCache = existingData;
                        attendanceCache.date = date; // Add date to cache

                        // NEW LOGIC: Open Detail View instead of Edit Form
                        // Add date to existingData so it's available in the detail modal
                        existingData.date = date;
                        openAttendanceDetail(existingData, empId, empName, empBranch);
                        return;

                        // updateFormFields(); (Unreachable now if we return above, which is what we want for existing flows)
                    } else {

                        // Reset form
                        document.getElementById('formStatus').value = '';
                        document.getElementById('formComment').value = '';
                        attendanceCache = {};
                        updateFormFields();
                    }
                }
            } catch (e) {
                console.error('Error fetching attendance data:', e);
            }

            document.getElementById('attendanceFormModal').style.display = 'flex';
        }

        function updateFormFields() {
            const status = document.getElementById('formStatus').value;
            const container = document.getElementById('conditionalFields');

            container.innerHTML = ''; // Clear previous fields

            if (status === 'delay') {
                // Arrival time for delays
                container.innerHTML = `
                    <div>
                        <label style="display: block; margin-bottom: 0.5rem; font-size: 0.9rem; color: #64748b; font-weight: 500;">Hora de Llegada</label>
                        <input type="time" id="formArrivalTime" value="${attendanceCache.arrival_time || ''}" style="width: 100%; padding: 0.8rem; border: 1px solid #cbd5e1; border-radius: 8px; font-family: inherit;">
                    </div>
                `;
            } else if (status === 'permission') {
                // Permission type
                container.innerHTML = `
                    <div>
                        <label style="display: block; margin-bottom: 0.5rem; font-size: 0.9rem; color: #64748b; font-weight: 500;">Tipo de Permiso</label>
                        <div style="display: flex; gap: 1rem;">
                            <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                                <input type="radio" name="permissionType" value="con goce" ${attendanceCache.permission_type === 'con goce' ? 'checked' : ''} style="cursor: pointer;">
                                <span>Con goce</span>
                            </label>
                            <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                                <input type="radio" name="permissionType" value="sin goce" ${attendanceCache.permission_type === 'sin goce' ? 'checked' : ''} style="cursor: pointer;">
                                <span>Sin goce</span>
                            </label>
                        </div>
                    </div>
                `;
            } else if (status === 'vacation') {
                // Vacation dates
                container.innerHTML = `
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                        <div>
                            <label style="display: block; margin-bottom: 0.5rem; font-size: 0.9rem; color: #64748b; font-weight: 500;">Fecha de Salida</label>
                            <input type="date" id="formStartDate" value="${attendanceCache.start_date || ''}" style="width: 100%; padding: 0.8rem; border: 1px solid #cbd5e1; border-radius: 8px; font-family: inherit;">
                        </div>
                        <div>
                            <label style="display: block; margin-bottom: 0.5rem; font-size: 0.9rem; color: #64748b; font-weight: 500;">Fecha de Regreso</label>
                            <input type="date" id="formEndDate" value="${attendanceCache.end_date || ''}" style="width: 100%; padding: 0.8rem; border: 1px solid #cbd5e1; border-radius: 8px; font-family: inherit;">
                        </div>
                    </div>
                `;
            } else if (status === 'incapacity') {
                // Sick leave dates
                container.innerHTML = `
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                        <div>
                            <label style="display: block; margin-bottom: 0.5rem; font-size: 0.9rem; color: #64748b; font-weight: 500;">Fecha de Inicio</label>
                            <input type="date" id="formStartDate" value="${attendanceCache.start_date || ''}" style="width: 100%; padding: 0.8rem; border: 1px solid #cbd5e1; border-radius: 8px; font-family: inherit;">
                        </div>
                        <div>
                            <label style="display: block; margin-bottom: 0.5rem; font-size: 0.9rem; color: #64748b; font-weight: 500;">Fecha de Fin</label>
                            <input type="date" id="formEndDate" value="${attendanceCache.end_date || ''}" style="width: 100%; padding: 0.8rem; border: 1px solid #cbd5e1; border-radius: 8px; font-family: inherit;">
                        </div>
                    </div>
                `;
            }
            // For 'present' and 'absent', no additional fields needed
        }

        // --- Detail View Logic ---
        function openAttendanceDetail(data, empId, empName, empBranch) {
            // Fix: Update global context so other functions (like switchToEditMode) work correctly
            currentFormData = {
                empId: empId,
                empName: empName,
                empBranch: empBranch,
                date: data.date
            };

            document.getElementById('detailEmployeeName').textContent = empName;
            document.getElementById('detailEmployeeBranch').textContent = empBranch;

            const statusLabels = {
                'present': '‚úÖ Asistencia', 'delay': '‚ö†Ô∏è Retardo', 'absent': '‚ùå Falta',
                'vacation': 'üèñÔ∏è Vacaciones', 'permission': 'üìã Permiso', 'incapacity': 'üè• Incapacidad'
            };
            document.getElementById('detailStatus').textContent = statusLabels[data.status] || data.status;
            document.getElementById('detailComment').textContent = data.comment || 'Sin comentarios.';

            const container = document.getElementById('detailConditionalFields');
            container.innerHTML = '';

            if (data.status === 'delay') {
                container.innerHTML = `
                   <div style="margin-bottom: 1rem;">
                        <label style="font-size: 0.85rem; color: #64748b;">Hora de Llegada</label>
                        <div style="font-weight: 500;">${data.arrival_time || '-'}</div>
                   </div>`;
            } else if (data.status === 'permission') {
                container.innerHTML = `
                   <div style="margin-bottom: 1rem;">
                        <label style="font-size: 0.85rem; color: #64748b;">Tipo de Permiso</label>
                        <div style="font-weight: 500; text-transform: capitalize;">${data.permission_type || '-'}</div>
                   </div>`;
            } else if (data.status === 'vacation' || data.status === 'incapacity') {
                container.innerHTML = `
                   <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                        <div>
                            <label style="font-size: 0.85rem; color: #64748b;">Fecha Inicio</label>
                            <div style="font-weight: 500;">${data.start_date || '-'}</div>
                        </div>
                        <div>
                            <label style="font-size: 0.85rem; color: #64748b;">Fecha Fin</label>
                            <div style="font-weight: 500;">${data.end_date || '-'}</div>
                        </div>
                   </div>`;
            }

            document.getElementById('attendanceDetailModal').style.display = 'flex';
        }

        function closeAttendanceDetail() {
            document.getElementById('attendanceDetailModal').style.display = 'none';
        }

        function switchToEditMode() {
            closeAttendanceDetail();
            // Populate form
            document.getElementById('formStatus').value = attendanceCache.status || '';
            document.getElementById('formComment').value = attendanceCache.comment || '';
            updateFormFields(); // This uses attendanceCache
            document.getElementById('attendanceFormModal').style.display = 'flex';
        }

        function closeAttendanceForm() {
            document.getElementById('attendanceFormModal').style.display = 'none';
            attendanceCache = {};
        }

        async function saveAttendanceForm() {
            const status = document.getElementById('formStatus').value;

            if (!status) {
                showToast('Por favor selecciona un estatus', 'warning');
                return;
            }

            const comment = document.getElementById('formComment').value;
            let arrival_time = null;
            let permission_type = null;
            let start_date = null;
            let end_date = null;

            // Gather conditional field data
            if (status === 'delay') {
                const timeInput = document.getElementById('formArrivalTime');
                arrival_time = timeInput ? timeInput.value : null;
            } else if (status === 'permission') {
                const selectedRadio = document.querySelector('input[name="permissionType"]:checked');
                permission_type = selectedRadio ? selectedRadio.value : null;
            } else if (status === 'vacation' || status === 'incapacity') {
                const startInput = document.getElementById('formStartDate');
                const endInput = document.getElementById('formEndDate');
                start_date = startInput ? startInput.value : null;
                end_date = endInput ? endInput.value : null;

                // Validar que ambas fechas est√©n presentes
                if (!start_date || !end_date) {
                    showToast('Por favor selecciona fecha de inicio y fin', 'warning');
                    return;
                }

                // Validar que la fecha de fin no sea anterior a la de inicio
                if (new Date(end_date) < new Date(start_date)) {
                    showToast('La fecha de fin no puede ser anterior a la fecha de inicio', 'warning');
                    return;
                }
            }

            try {
                // Para vacaciones, permisos e incapacidad con rango de fechas
                if ((status === 'vacation' || status === 'incapacity') && start_date && end_date) {
                    // Crear un registro para cada d√≠a del rango
                    const startDateObj = new Date(start_date);
                    const endDateObj = new Date(end_date);
                    const promises = [];

                    // Iterar por cada d√≠a del rango
                    for (let d = new Date(startDateObj); d <= endDateObj; d.setDate(d.getDate() + 1)) {
                        const dateStr = d.toISOString().split('T')[0];

                        promises.push(
                            fetch(`${API_BASE_URL}/attendance/mark`, {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({
                                    employee_id: currentFormData.empId,
                                    date: dateStr,
                                    status: status,
                                    comment: comment,
                                    arrival_time: null,
                                    permission_type: permission_type,
                                    start_date: start_date,
                                    end_date: end_date
                                })
                            })
                        );
                    }

                    // Esperar a que todos los registros se guarden
                    await Promise.all(promises);
                    showToast(`${status === 'vacation' ? 'Vacaciones' : 'Incapacidad'} registrada del ${start_date} al ${end_date}`, 'success');
                } else {
                    // Para otros estados o registros individuales
                    await fetch(`${API_BASE_URL}/attendance/mark`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            employee_id: currentFormData.empId,
                            date: currentFormData.date,
                            status: status,
                            comment: comment,
                            arrival_time: arrival_time,
                            permission_type: permission_type,
                            start_date: start_date,
                            end_date: end_date
                        })
                    });
                    showToast('Asistencia guardada correctamente', 'success');
                }

                closeAttendanceForm();
                fetchAndRenderAttendance(); // Reload grid
            } catch (e) {
                console.error('Error saving attendance:', e);
                showToast('Error al guardar', 'error');
            }
        }

        // --- Roster Logic ---
        async function openAddRosterModal() {
            document.getElementById('rosterModal').style.display = 'flex';
            const list = document.getElementById('rosterList');
            list.innerHTML = '<p style="padding: 1rem;">Cargando...</p>';

            try {
                const res = await fetch(`${API_BASE_URL}/employees`); // Get all employees
                const result = await res.json();
                if (result.success) {
                    totalEmployees = result.data;
                    renderRosterOptions(totalEmployees);
                }
            } catch (e) { list.innerHTML = 'Error'; }
        }

        function renderRosterOptions(emps) {
            const list = document.getElementById('rosterList');
            if (emps.length === 0) { list.innerHTML = '<p style="padding:1rem;">No encontrado</p>'; return; }

            let html = '';
            emps.forEach(emp => {
                html += `
                    <div onclick="addToRoster(${emp.id})" style="padding: 0.8rem; border-bottom: 1px solid #f1f5f9; cursor: pointer; transition: background 0.2s;" onmouseover="this.style.background='#f8fafc'" onmouseout="this.style.background='white'">
                        <strong>${emp.full_name}</strong>
                        <div style="font-size: 0.8rem; color: #94a3b8;">${emp.branch_name || 'Sin sucursal'}</div>
                    </div>
                `;
            });
            list.innerHTML = html;
        }

        function filterRosterOptions() {
            const term = document.getElementById('rosterSearch').value.toLowerCase();
            const filtered = totalEmployees.filter(e => e.full_name.toLowerCase().includes(term));
            renderRosterOptions(filtered);
        }

        async function addToRoster(id) {
            try {
                const userStr = sessionStorage.getItem('user');
                if (!userStr) return;
                const user = JSON.parse(userStr);

                await fetch(`${API_BASE_URL}/attendance/roster`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ employee_id: id, userId: user.id })
                });
                document.getElementById('rosterModal').style.display = 'none';
                loadAsistencias(); // Reload grid
                showToast('Colaborador agregado a la lista', 'success');
            } catch (e) {
                showToast('Error al agregar', 'error');
            }
        }
        async function loadJefesOficina() {
            stopAutoRefresh(); // Detener auto-refresco al cambiar de pesta√±a
            updateActiveLink('Jefes de Oficina');
            document.getElementById('pageTitle').innerText = 'Jefes de Oficina';
            document.getElementById('statsGrid').style.display = 'none';

            const content = document.getElementById('contentArea');
            // Header with Add Button
            content.innerHTML = `
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                    <div style="display: flex; align-items: center; gap: 1rem; flex: 1;">
                        <p style="margin: 0;">Total de registros: <span id="totalCount">...</span></p>
                         <div style="max-width: 250px; width: 100%;">
                             <select id="jefesBranchFilter" onchange="filterJefesTable()" style="width: 100%; padding: 0.5rem; border: 1px solid #cbd5e1; border-radius: 6px; color: #475569;">
                                 <option value="">Todas las sucursales</option>
                            </select>
                        </div>
                    </div>
                    <button class="btn-primary" onclick="openAddModal()" style="width: auto; padding: 0.6rem 1.2rem; font-size: 0.9rem;">
                        + Agregar Nuevo
                    </button>
                </div>
                <div id="tableContainer"><p>Cargando datos...</p></div>
                
            `;

            try {
                // Fetch Employees
                const resEmp = await fetch(`${API_BASE_URL}/employees`);
                const resultEmp = await resEmp.json();

                // Fetch Branches for Modal
                loadBranches();

                if (resultEmp.success) {
                    const employees = resultEmp.data;
                    document.getElementById('totalCount').innerText = employees.length;

                    const branches = new Set();

                    let html = `
                        <table style="width: 100%; border-collapse: collapse;">
                            <thead>
                                <tr style="text-align: left; border-bottom: 2px solid #e2e8f0;">
                                    <th style="padding: 1rem; color: var(--text-light);">Nombre</th>
                                    <th style="padding: 1rem; color: var(--text-light);">Sucursal</th>
                                    <th style="padding: 1rem; color: var(--text-light);">Fecha Ingreso</th>
                                    <th style="padding: 1rem; color: var(--text-light);">Estatus</th>
                                    <th style="padding: 1rem; color: var(--text-light);">Acciones</th>
                                </tr>
                            </thead>
                            <tbody id="jefesTableBody">
                    `;

                    employees.forEach(emp => {
                        if (emp.branch_name) branches.add(emp.branch_name);
                        html += `
                            <tr style="border-bottom: 1px solid #f1f5f9; transition: background 0.2s;" onmouseover="this.style.background='rgba(79, 70, 229, 0.05)'" onmouseout="this.style.background='transparent'" data-branch="${emp.branch_name || ''}">
                                <td style="padding: 1rem; font-weight: 500;">${emp.full_name}</td>
                                <td style="padding: 1rem;">${emp.branch_name || 'Sin asignar'}</td>
                                <td style="padding: 1rem;">${emp.hire_date || '-'}</td>
                                <td style="padding: 1rem;"><span style="padding: 0.25rem 0.75rem; background: #dcfce7; color: #166534; border-radius: 99px; font-size: 0.85rem;">${emp.status}</span></td>
                                <td style="padding: 1rem; display: flex; gap: 0.5rem;">
                                    <button title="Editar" onclick="openEditModal(${emp.id}, '${emp.full_name}', ${emp.branch_id}, '${emp.hire_date || ''}')" style="border: none; background: none; cursor: pointer; color: var(--primary-color);">‚úèÔ∏è</button>
                                    <button title="Eliminar" onclick="deleteEmployee(${emp.id}, '${emp.full_name}')" style="border: none; background: none; cursor: pointer; color: #ef4444;">üóëÔ∏è</button>
                                </td>
                            </tr>
                        `;
                    });

                    // Populate Filter
                    const filterSelect = document.getElementById('jefesBranchFilter');
                    if (filterSelect) {
                        filterSelect.innerHTML = '<option value="">Todas las sucursales</option>';
                        Array.from(branches).sort().forEach(b => {
                            const opt = document.createElement('option');
                            opt.value = b;
                            opt.textContent = b;
                            filterSelect.appendChild(opt);
                        });
                    }

                    html += '</tbody></table>';
                    document.getElementById('tableContainer').innerHTML = html;
                } else {
                    document.getElementById('tableContainer').innerHTML = '<p style="color: red;">Error al cargar datos.</p>';
                }
            } catch (err) {
                console.error(err);
                document.getElementById('tableContainer').innerHTML = '<p style="color: red;">Error de conexi√≥n.</p>';
            }
        }

        function filterJefesTable() {
            const filter = document.getElementById('jefesBranchFilter').value;
            const rows = document.querySelectorAll('#jefesTableBody tr');
            rows.forEach(row => {
                const branch = row.getAttribute('data-branch');
                // show if no filter or matches
                if (!filter || branch === filter) {
                    row.style.display = '';
                } else {
                    row.style.display = 'none';
                }
            });
        }

        // --- INCIDENTS LOGIC ---
        let incidentsCache = [];
        let incidentStaffCache = []; // Cache for employees dropdown in incidents modal

        async function loadIncidents() {
            stopAutoRefresh(); // Detener auto-refresco al cambiar de pesta√±a
            updateActiveLink('Incidencias');
            document.getElementById('pageTitle').innerText = 'Control de Incidencias';
            document.getElementById('statsGrid').style.display = 'none'; // Hide stats if any

            // Header with New Report Button
            const content = document.getElementById('contentArea');
            content.innerHTML = `
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                     <!-- Branch Filter -->
                    <div style="flex: 1; max-width: 300px;">
                         <select id="incidentsBranchFilter" onchange="filterIncidentsTable()" style="width: 100%; padding: 0.6rem 1rem; border: 1px solid #cbd5e1; border-radius: 8px; color: #475569;">
                            <option value="">Todas las sucursales</option>
                        </select>
                    </div>

                    <button class="btn-primary" onclick="openNewIncidentModal()" style="width: auto; padding: 0.6rem 1.2rem; font-size: 0.9rem;">
                        + Nuevo Reporte
                    </button>
                </div>
                <div id="incidentsTableContainer">
                     <p>Cargando incidencias...</p>
                </div>
            `;

            // Inject Notification Center Modal if not present
            if (!document.getElementById('notificationModal')) {
                document.body.insertAdjacentHTML('beforeend', `
                    <div id="notificationModal" style="display: none; position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background: rgba(0,0,0,0.5); justify-content: center; align-items: center; z-index: 10001;">
                        <div style="background: white; padding: 2rem; border-radius: 12px; width: 500px; max-width: 90%; max-height: 90vh; display: flex; flex-direction: column;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; padding-bottom: 1rem; border-bottom: 1px solid #e2e8f0;">
                                <h3 style="margin: 0; color: #1e293b;">Notificaciones</h3>
                                <button onclick="document.getElementById('notificationModal').style.display='none'" style="background: none; border: none; font-size: 1.5rem; cursor: pointer; color: #64748b;">&times;</button>
                            </div>
                            
                            <div id="notificationList" style="overflow-y: auto; flex: 1;">
                                <p style="text-align: center; color: #94a3b8; padding: 1rem;">Cargando...</p>
                            </div>
                            
                            <div style="margin-top: 1rem; text-align: right;">
                                <button onclick="document.getElementById('notificationModal').style.display='none'" style="padding: 0.6rem 1.2rem; background: #f1f5f9; color: #475569; border: none; border-radius: 6px; cursor: pointer;">Cerrar</button>
                            </div>
                        </div>
                    </div>
                 `);
            }

            // Inject New Incident Modal if not present
            if (!document.getElementById('newIncidentModal')) {
                document.body.insertAdjacentHTML('beforeend', `
                    <div id="newIncidentModal" style="display: none; position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background: rgba(0,0,0,0.5); justify-content: center; align-items: center; z-index: 200;">
                        <div style="background: white; padding: 2rem; border-radius: 12px; width: 500px; max-width: 90%; max-height: 90vh; overflow-y: auto;">
                            <h3 style="margin-top: 0; color: #1e293b;">Nuevo Reporte de Incidencia</h3>
                            
                            <div style="display: grid; gap: 1rem;">
                                <div>
                                    <label style="display: block; font-size: 0.85rem; color: #64748b; margin-bottom: 0.25rem;">Colaborador</label>
                                    <select id="incColaborador" style="width: 100%; padding: 0.6rem; border: 1px solid #cbd5e1; border-radius: 6px;" onchange="autoFillBranch()">
                                        <option value="">Seleccionar colaborador...</option>
                                    </select>
                                </div>
                                
                                <div>
                                    <label style="display: block; font-size: 0.85rem; color: #64748b; margin-bottom: 0.25rem;">Sucursal</label>
                                    <input type="text" id="incSucursal" readonly style="width: 100%; padding: 0.6rem; border: 1px solid #cbd5e1; border-radius: 6px; background: #f1f5f9; color: #64748b;">
                                </div>

                                <div>
                                    <label style="display: block; font-size: 0.85rem; color: #64748b; margin-bottom: 0.25rem;">Tipo de Incidencia</label>
                                    <select id="incTipo" style="width: 100%; padding: 0.6rem; border: 1px solid #cbd5e1; border-radius: 6px;">
                                        <option value="RENTA">RENTA</option>
                                        <option value="LUZ">LUZ</option>
                                        <option value="INTERNET">INTERNET</option>
                                        <option value="EQUIPO DE COMPUTO">EQUIPO DE COMPUTO</option>
                                        <option value="USUARIOS">USUARIOS</option>
                                        <option value="CORREO">CORREO</option>
                                        <option value="SUC. CLAUSURADA">SUC. CLAUSURADA</option>
                                    </select>
                                </div>

                                <div>
                                    <label style="display: block; font-size: 0.85rem; color: #64748b; margin-bottom: 0.25rem;">Estatus</label>
                                    <select id="incEstatus" style="width: 100%; padding: 0.6rem; border: 1px solid #cbd5e1; border-radius: 6px;">
                                        <option value="EN PROCESO">EN PROCESO</option>
                                        <option value="CONCLUIDO">CONCLUIDO</option>
                                        <option value="SIN RESPUESTA">SIN RESPUESTA</option>
                                    </select>
                                </div>

                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                                    <div>
                                        <label style="display: block; font-size: 0.85rem; color: #64748b; margin-bottom: 0.25rem;">Fecha Inicio</label>
                                        <input type="date" id="incFechaInicio" style="width: 100%; padding: 0.6rem; border: 1px solid #cbd5e1; border-radius: 6px;">
                                    </div>
                                    <div>
                                        <label style="display: block; font-size: 0.85rem; color: #64748b; margin-bottom: 0.25rem;">Fecha Fin</label>
                                        <input type="date" id="incFechaFin" style="width: 100%; padding: 0.6rem; border: 1px solid #cbd5e1; border-radius: 6px;">
                                    </div>
                                </div>

                                <div>
                                    <label style="display: block; font-size: 0.85rem; color: #64748b; margin-bottom: 0.25rem;">Comentario</label>
                                    <textarea id="incComentario" rows="3" style="width: 100%; padding: 0.6rem; border: 1px solid #cbd5e1; border-radius: 6px;"></textarea>
                                </div>
                            </div>

                            <div style="display: flex; gap: 1rem; justify-content: flex-end; margin-top: 1.5rem;">
                                <button onclick="document.getElementById('newIncidentModal').style.display='none'" style="padding: 0.8rem 1.5rem; border: 1px solid #cbd5e1; background: white; border-radius: 8px; cursor: pointer;">Cancelar</button>
                                <button onclick="saveIncident()" class="btn-primary" style="width: auto; padding: 0.8rem 1.5rem;">Guardar Reporte</button>
                            </div>
                        </div>
                    </div>
                `);
            }

            try {
                const userStr = sessionStorage.getItem('user');
                const user = userStr ? JSON.parse(userStr) : null;
                const userId = user ? user.id : '';
                const response = await fetch(`${API_BASE_URL}/incidents?userId=${userId}`);
                const result = await response.json();

                if (result.success) {
                    renderIncidentsTable(result.data);
                } else {
                    document.getElementById('incidentsTableContainer').innerHTML = '<p style="color: red;">Error al cargar incidencias.</p>';
                }
            } catch (e) {
                console.error(e);
                document.getElementById('incidentsTableContainer').innerHTML = '<p style="color: red;">Error de conexi√≥n.</p>';
            }
        }

        function renderIncidentsTable(incidents) {
            if (incidents.length === 0) {
                document.getElementById('incidentsTableContainer').innerHTML = '<div style="padding: 2rem; text-align: center; color: #64748b; background: white; border-radius: 12px; border: 1px solid #e2e8f0;">No hay reportes de incidencias.</div>';
                return;
            }

            let html = `
                <table style="width: 100%; border-collapse: collapse; background: white; border-radius: 12px; overflow: hidden; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);">
                    <thead style="background: #f8fafc; border-bottom: 2px solid #e2e8f0;">
                        <tr>
                            <th style="padding: 1rem; text-align: left; color: #475569; font-weight: 600;">Estatus</th>
                            <th style="padding: 1rem; text-align: left; color: #475569; font-weight: 600;">Tipo</th>
                            <th style="padding: 1rem; text-align: left; color: #475569; font-weight: 600;">Sucursal</th>
                            <th style="padding: 1rem; text-align: left; color: #475569; font-weight: 600;">Colaborador</th>
                            <th style="padding: 1rem; text-align: left; color: #475569; font-weight: 600;">Fechas</th>
                            <th style="padding: 1rem; text-align: left; color: #475569; font-weight: 600;">Comentario</th>
                            <th style="padding: 1rem; text-align: left; color: #475569; font-weight: 600;">Acciones</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            const branches = new Set();

            incidents.forEach(inc => {
                let statusColor = '#e2e8f0'; // Default gray
                if (inc.status === 'EN PROCESO') statusColor = '#fef08a'; // Yellow 200
                if (inc.status === 'CONCLUIDO') statusColor = '#bbf7d0'; // Green 200
                if (inc.status === 'SIN RESPUESTA') statusColor = '#fca5a5'; // Red 300

                if (inc.branch_name) branches.add(inc.branch_name);

                html += `
                    <tr style="border-bottom: 1px solid #f1f5f9;" data-branch="${inc.branch_name || ''}">
                        <td style="padding: 1rem;">
                            <span style="display: inline-block; padding: 0.25rem 0.75rem; border-radius: 999px; background-color: ${statusColor}; font-weight: 500; font-size: 0.85rem; color: #1e293b;">
                                ${inc.status}
                            </span>
                        </td>
                        <td style="padding: 1rem; font-weight: 500;">${inc.type}</td>
                        <td style="padding: 1rem; color: #64748b;">${inc.branch_name || '-'}</td>
                        <td style="padding: 1rem;">${inc.reported_by_name || '-'}</td>
                        <td style="padding: 1rem; font-size: 0.9rem;">
                            <div style="color: #64748b;">In: ${inc.start_date || '-'}</div>
                            <div style="color: #64748b;">Fin: ${inc.end_date || '-'}</div>
                        </td>
                        <td style="padding: 1rem; font-style: italic; color: #475569;">${inc.description || ''}</td>
                        <td style="padding: 1rem; display: flex; gap: 0.5rem;">
                            <button title="Editar" onclick="openEditIncidentModal(${JSON.stringify(inc).replace(/"/g, '&quot;')})" style="border: none; background: none; cursor: pointer; color: var(--primary-color);">‚úèÔ∏è</button>
                            <button title="Eliminar" onclick="deleteIncident(${inc.id})" style="border: none; background: none; cursor: pointer; color: #ef4444;">üóëÔ∏è</button>
                        </td>
                    </tr>
                `;
            });

            html += '</tbody></table>';
            document.getElementById('incidentsTableContainer').innerHTML = html;

            // Populate Branch Filter
            const filterSelect = document.getElementById('incidentsBranchFilter');
            if (filterSelect) {
                const currentVal = filterSelect.value;
                filterSelect.innerHTML = '<option value="">Todas las sucursales</option>';
                Array.from(branches).sort().forEach(b => {
                    const opt = document.createElement('option');
                    opt.value = b;
                    opt.textContent = b;
                    filterSelect.appendChild(opt);
                });
                filterSelect.value = currentVal;
                filterIncidentsTable();
            }
        }

        function filterIncidentsTable() {
            const filter = document.getElementById('incidentsBranchFilter').value;
            const rows = document.querySelectorAll('#incidentsTableContainer tbody tr');
            rows.forEach(row => {
                const branch = row.getAttribute('data-branch');
                if (!filter || branch === filter) {
                    row.style.display = '';
                } else {
                    row.style.display = 'none';
                }
            });
        }

        async function openNewIncidentModal() {
            document.getElementById('newIncidentModal').style.display = 'flex';

            // Load employees for dropdown if not already loaded
            if (incidentStaffCache.length === 0) {
                try {
                    const res = await fetch(`${API_BASE_URL}/employees`);
                    const result = await res.json();
                    if (result.success) {
                        incidentStaffCache = result.data;
                        const select = document.getElementById('incColaborador');
                        select.innerHTML = '<option value="">Seleccionar colaborador...</option>';
                        incidentStaffCache.forEach(emp => {
                            const opt = document.createElement('option');
                            opt.value = emp.id;
                            opt.textContent = emp.full_name;
                            select.appendChild(opt);
                        });
                    }
                } catch (e) { }
            }
        }

        // --- ALERTS SYSTEM ---
        let shownAlertIds = new Set();
        let pendingAlerts = [];
        let alertPollInterval = null;

        async function startAlertPolling() {
            checkAlerts();
            alertPollInterval = setInterval(checkAlerts, 30000); // Check every 30s
        }

        async function checkAlerts() {
            try {
                const userStr = sessionStorage.getItem('user');
                if (!userStr) return;
                const user = JSON.parse(userStr);

                // Fetch unread for badges and toasting
                const res = await fetch(`${API_BASE_URL}/alerts?userId=${user.id}&mode=unread`);
                const result = await res.json();

                if (result.success) {
                    pendingAlerts = result.data;
                    updateAlertUI();

                    let newAlertsFound = false;
                    // Show new alerts
                    pendingAlerts.forEach(alert => {
                        if (!shownAlertIds.has(alert.id)) {
                            showAlertToast(alert);
                            shownAlertIds.add(alert.id);
                            newAlertsFound = true;
                        }
                    });

                    if (newAlertsFound) {
                        playAlertSound();
                    }
                }
            } catch (e) {
                console.error('Error checking alerts:', e);
            }
        }

        function playAlertSound() {
            try {
                const audio = new Audio('too_bad.mp3');
                audio.play().catch(e => console.warn('Audio playback prevented by browser policy:', e));
            } catch (e) {
                console.error('Error playing notification sound:', e);
            }
        }

        function updateAlertUI() {
            const container = document.getElementById('alertIconContainer');
            const badge = document.getElementById('alertBadge');

            // Icon always visible now
            // Badge only if alerts > 0
            if (pendingAlerts.length > 0) {
                badge.style.display = 'flex';
                badge.innerText = pendingAlerts.length;
                container.style.animation = 'alertPulse 2s infinite';
            } else {
                badge.style.display = 'none';
                container.style.animation = 'none';
            }
        }

        async function openNotificationCenter() {
            const modal = document.getElementById('notificationModal');
            const list = document.getElementById('notificationList');
            if (!modal || !list) return;

            modal.style.display = 'flex';
            list.innerHTML = '<p style="text-align: center; color: #94a3b8; padding: 1rem;">Cargando historial...</p>';

            try {
                const userStr = sessionStorage.getItem('user');
                if (!userStr) return;
                const user = JSON.parse(userStr);

                // Fetch ALL alerts (history)
                const res = await fetch(`${API_BASE_URL}/alerts?userId=${user.id}&mode=all`);
                const result = await res.json();

                if (result.success && result.data.length > 0) {
                    list.innerHTML = result.data.map(alert => renderNotificationItem(alert)).join('');
                } else {
                    list.innerHTML = '<div style="text-align: center; color: #94a3b8; padding: 2rem;">No tienes notificaciones.</div>';
                }
            } catch (e) {
                list.innerHTML = '<div style="color: red; padding: 1rem;">Error cargando notificaciones.</div>';
            }
        }

        function renderNotificationItem(alert) {
            const isUnread = !alert.is_read;
            // Styling for history
            const bgClass = isUnread ? 'background: #fef2f2;' : 'background: white;';
            const borderClass = isUnread ? 'border-left: 4px solid #ef4444;' : 'border-left: 4px solid #cbd5e1;';
            const opacity = isUnread ? 'opacity: 1;' : 'opacity: 0.8;';

            let content = '';
            if (alert.details.type === '3_delays') {
                const delaysHtml = alert.details.delays.map(d =>
                    `<div style="font-size: 0.85rem; color: #64748b;">‚Ä¢ <strong>${d.date}</strong>: ${d.comment}</div>`
                ).join('');

                content = `
                    <div style="font-weight: 600; color: #1e293b; margin-bottom: 0.25rem;">
                        ${alert.details.subtype === 'accumulated' ? '‚ö†Ô∏è Retardos Acumulados' : '‚ö†Ô∏è Retardos Consecutivos'}
                    </div>
                    <div style="font-size: 0.9rem; color: #334155; margin-bottom: 0.5rem;">
                        El colaborador <strong>${alert.details.employee_name}</strong> ha registrado ${alert.details.count || 3} retardos en ${alert.details.month || 'el periodo'}.
                    </div>
                    <div style="background: rgba(0,0,0,0.02); padding: 0.5rem; border-radius: 6px;">
                        ${delaysHtml}
                    </div>
                `;
            } else {
                content = `<div style="color: #334155;">${JSON.stringify(alert.details)}</div>`;
            }

            return `
                <div style="${bgClass} ${borderClass} ${opacity} padding: 1rem; border-radius: 4px; margin-bottom: 0.75rem; box-shadow: 0 1px 3px rgba(0,0,0,0.05);">
                    <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 0.5rem;">
                        <span style="font-size: 0.75rem; color: #94a3b8;">${alert.created_at.replace('T', ' ').substring(0, 16)}</span>
                        ${isUnread ? `<button onclick="markAlertRead(${alert.id})" style="font-size: 0.75rem; color: #2563eb; background: none; border: none; cursor: pointer; text-decoration: underline;">Marcar le√≠da</button>` : '<span style="font-size: 0.75rem; color: #10b981;">Le√≠da</span>'}
                    </div>
                    ${content}
                </div>
            `;
        }

        function showAlertToast(alert) {
            if (alert.details.type === '3_delays') {
                const delaysHtml = alert.details.delays.map(d =>
                    `<li style="margin-bottom:4px;">
                        <strong>${d.date}</strong>: 
                        <span style="color:#000000; font-style:italic;">"${d.comment}"</span>
                     </li>`
                ).join('');

                const content = `
                    <div style="min-width: 280px; color: #000000;">
                        <div style="font-weight:700; color:#b91c1c; margin-bottom:6px; display:flex; align-items:center; gap:6px;">
                            <span>‚ö†Ô∏è</span> ${alert.details.subtype === 'accumulated' ? 'Retardos Acumulados' : '3 Retardos Consecutivos'}
                        </div>
                        <div style="font-weight:600; margin-bottom:8px; font-size:1.05em; color: #000000;">${alert.details.employee_name}</div>
                        <ul style="margin:0 0 12px 18px; padding:0; font-size:0.9em; color:#000000;">
                            ${delaysHtml}
                        </ul>
                        <button onclick="markAlertRead(${alert.id})" style="width:100%; padding:8px; background:#b91c1c; color:white; border:none; border-radius:6px; cursor:pointer; font-weight:600; transition: background 0.2s;" onmouseover="this.style.background='#991b1b'" onmouseout="this.style.background='#b91c1c'">
                            Entendido
                        </button>
                    </div>
                `;

                showCustomToast(content, 'warning', 0);
            }
        }

        async function markAlertRead(alertId) {
            try {
                await fetch(`${API_BASE_URL}/alerts/mark-read`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ alert_id: alertId })
                });

                // Remove from pending locally
                pendingAlerts = pendingAlerts.filter(a => a.id !== alertId);
                updateAlertUI();

                // Close toasts
                dismissAllToasts();

                // If modal is open, refresh it
                const modal = document.getElementById('notificationModal');
                if (modal && modal.style.display !== 'none') {
                    openNotificationCenter();
                }

                showToast('Notificaci√≥n marcada como le√≠da', 'success');
            } catch (e) {
                console.error(e);
            }
        }

        function showPendingAlerts() {
            openNotificationCenter();
        }

        // Expose needed functions
        window.markAlertRead = markAlertRead;
        window.showPendingAlerts = showPendingAlerts;
        window.openNotificationCenter = openNotificationCenter;

        // Add animation style
        const alertStyle = document.createElement('style');
        alertStyle.textContent = `
    @keyframes alertPulse {
        0% { transform: scale(1); }
        50% { transform: scale(1.1); }
        100% { transform: scale(1); }
    }
    `;
        document.head.appendChild(alertStyle);

        function autoFillBranch() {
            const empId = document.getElementById('incColaborador').value;
            const emp = incidentStaffCache.find(e => e.id == empId);
            if (emp) {
                document.getElementById('incSucursal').value = emp.branch_name || 'Sin asignar';
            } else {
                document.getElementById('incSucursal').value = '';
            }
        }

        async function saveIncident() {
            const empId = document.getElementById('incColaborador').value;
            if (!empId) {
                showToast('Selecciona un colaborador', 'warning');
                return;
            }

            // Obtener branch_id del empleado seleccionado
            const emp = incidentStaffCache.find(e => e.id == empId);
            const branchId = emp ? emp.branch_id : null;

            const type = document.getElementById('incTipo').value;
            const status = document.getElementById('incEstatus').value;
            const startDate = document.getElementById('incFechaInicio').value;
            const endDate = document.getElementById('incFechaFin').value;
            const comment = document.getElementById('incComentario').value;

            try {
                const res = await fetch(`${API_BASE_URL}/incidents`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        reported_by: empId,  // Campo correcto para el backend
                        branch_id: branchId,
                        type,
                        status,
                        start_date: startDate,
                        end_date: endDate,
                        description: comment
                    })
                });

                const result = await res.json();
                if (result.success) {
                    document.getElementById('newIncidentModal').style.display = 'none';
                    // Clear form
                    document.getElementById('incColaborador').value = '';
                    document.getElementById('incSucursal').value = '';
                    document.getElementById('incComentario').value = '';
                    loadIncidents(); // Refresh grid
                    showToast('Incidencia guardada correctamente', 'success');
                } else {
                    showToast('Error: ' + result.message, 'error');
                }
            } catch (e) {
                console.error(e);
                showToast('Error al guardar reporte', 'error');
            }
        }

        async function deleteIncident(id) {
            showConfirmToast('¬øEst√°s seguro de eliminar este reporte?', async () => {
                try {
                    const res = await fetch(`${API_BASE_URL}/incidents/${id}`, { method: 'DELETE' });
                    const result = await res.json();
                    if (result.success) {
                        loadIncidents();
                        showToast('Reporte eliminado correctamente', 'success');
                    } else {
                        showToast('Error al eliminar: ' + result.message, 'error');
                    }
                } catch (e) {
                    showToast('Error de conexi√≥n', 'error');
                }
            });
        }

        async function openEditIncidentModal(inc) {
            // Ensure modal exists
            if (!document.getElementById('editIncidentModal')) {
                // Clone newIncidentModal structure but change IDs
                const modalHTML = `
                    <div id="editIncidentModal" style="display: none; position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background: rgba(0,0,0,0.5); justify-content: center; align-items: center; z-index: 200;">
                        <div style="background: white; padding: 2rem; border-radius: 12px; width: 500px; max-width: 90%; max-height: 90vh; overflow-y: auto;">
                            <h3 style="margin-top: 0; color: #1e293b;">Editar Incidencia</h3>
                            <input type="hidden" id="editIncId">
                            
                            <div style="display: grid; gap: 1rem;">
                                <div>
                                    <label style="display: block; font-size: 0.85rem; color: #64748b; margin-bottom: 0.25rem;">Colaborador</label>
                                    <select id="editIncColaborador" style="width: 100%; padding: 0.6rem; border: 1px solid #cbd5e1; border-radius: 6px;" onchange="autoFillEditBranch()">
                                        <option value="">Seleccionar colaborador...</option>
                                    </select>
                                </div>
                                
                                <div>
                                    <label style="display: block; font-size: 0.85rem; color: #64748b; margin-bottom: 0.25rem;">Sucursal</label>
                                    <input type="text" id="editIncSucursal" readonly style="width: 100%; padding: 0.6rem; border: 1px solid #cbd5e1; border-radius: 6px; background: #f1f5f9; color: #64748b;">
                                </div>

                                <div>
                                    <label style="display: block; font-size: 0.85rem; color: #64748b; margin-bottom: 0.25rem;">Tipo de Incidencia</label>
                                    <select id="editIncTipo" style="width: 100%; padding: 0.6rem; border: 1px solid #cbd5e1; border-radius: 6px;">
                                        <option value="RENTA">RENTA</option>
                                        <option value="LUZ">LUZ</option>
                                        <option value="INTERNET">INTERNET</option>
                                        <option value="EQUIPO DE COMPUTO">EQUIPO DE COMPUTO</option>
                                        <option value="USUARIOS">USUARIOS</option>
                                        <option value="CORREO">CORREO</option>
                                        <option value="SUC. CLAUSURADA">SUC. CLAUSURADA</option>
                                    </select>
                                </div>

                                <div>
                                    <label style="display: block; font-size: 0.85rem; color: #64748b; margin-bottom: 0.25rem;">Estatus</label>
                                    <select id="editIncEstatus" style="width: 100%; padding: 0.6rem; border: 1px solid #cbd5e1; border-radius: 6px;">
                                        <option value="EN PROCESO">EN PROCESO</option>
                                        <option value="CONCLUIDO">CONCLUIDO</option>
                                        <option value="SIN RESPUESTA">SIN RESPUESTA</option>
                                    </select>
                                </div>

                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                                    <div>
                                        <label style="display: block; font-size: 0.85rem; color: #64748b; margin-bottom: 0.25rem;">Fecha Inicio</label>
                                        <input type="date" id="editIncFechaInicio" style="width: 100%; padding: 0.6rem; border: 1px solid #cbd5e1; border-radius: 6px;">
                                    </div>
                                    <div>
                                        <label style="display: block; font-size: 0.85rem; color: #64748b; margin-bottom: 0.25rem;">Fecha Fin</label>
                                        <input type="date" id="editIncFechaFin" style="width: 100%; padding: 0.6rem; border: 1px solid #cbd5e1; border-radius: 6px;">
                                    </div>
                                </div>

                                <div>
                                    <label style="display: block; font-size: 0.85rem; color: #64748b; margin-bottom: 0.25rem;">Comentario</label>
                                    <textarea id="editIncComentario" rows="3" style="width: 100%; padding: 0.6rem; border: 1px solid #cbd5e1; border-radius: 6px;"></textarea>
                                </div>
                            </div>

                            <div style="display: flex; gap: 1rem; justify-content: flex-end; margin-top: 1.5rem;">
                                <button onclick="document.getElementById('editIncidentModal').style.display='none'" style="padding: 0.8rem 1.5rem; border: 1px solid #cbd5e1; background: white; border-radius: 8px; cursor: pointer;">Cancelar</button>
                                <button onclick="saveEditedIncident()" class="btn-primary" style="width: auto; padding: 0.8rem 1.5rem;">Guardar Cambios</button>
                            </div>
                        </div>
                    </div>
                `;
                document.body.insertAdjacentHTML('beforeend', modalHTML);
            }

            // Populate employees if needed
            if (incidentStaffCache.length === 0) {
                try {
                    const res = await fetch(`${API_BASE_URL}/employees`);
                    const result = await res.json();
                    if (result.success) incidentStaffCache = result.data;
                } catch (e) { }
            }

            const select = document.getElementById('editIncColaborador');
            select.innerHTML = '<option value="">Seleccionar colaborador...</option>';
            incidentStaffCache.forEach(emp => {
                const opt = document.createElement('option');
                opt.value = emp.id;
                opt.textContent = emp.full_name;
                select.appendChild(opt);
            });

            // Set values
            document.getElementById('editIncId').value = inc.id;
            document.getElementById('editIncColaborador').value = inc.reported_by;
            document.getElementById('editIncSucursal').value = inc.branch_name || '';
            document.getElementById('editIncTipo').value = inc.type;
            document.getElementById('editIncEstatus').value = inc.status;
            document.getElementById('editIncFechaInicio').value = inc.start_date || '';
            document.getElementById('editIncFechaFin').value = inc.end_date || '';
            document.getElementById('editIncComentario').value = inc.description || '';

            document.getElementById('editIncidentModal').style.display = 'flex';
        }

        function autoFillEditBranch() {
            const empId = document.getElementById('editIncColaborador').value;
            const emp = incidentStaffCache.find(e => e.id == empId);
            if (emp) {
                document.getElementById('editIncSucursal').value = emp.branch_name || 'Sin asignar';
            } else {
                document.getElementById('editIncSucursal').value = '';
            }
        }

        async function saveEditedIncident() {
            const id = document.getElementById('editIncId').value;
            const empId = document.getElementById('editIncColaborador').value;
            const type = document.getElementById('editIncTipo').value;
            const status = document.getElementById('editIncEstatus').value;
            const startDate = document.getElementById('editIncFechaInicio').value;
            const endDate = document.getElementById('editIncFechaFin').value;
            const comment = document.getElementById('editIncComentario').value;

            if (!empId) {
                showToast('Selecciona un colaborador', 'warning');
                return;
            }

            // Obtener branch_id del empleado seleccionado
            const emp = incidentStaffCache.find(e => e.id == empId);
            const branchId = emp ? emp.branch_id : null;

            try {
                const res = await fetch(`${API_BASE_URL}/incidents/${id}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        reported_by: empId,
                        branch_id: branchId,
                        type,
                        status,
                        start_date: startDate,
                        end_date: endDate,
                        description: comment
                    })
                });
                const result = await res.json();
                if (result.success) {
                    document.getElementById('editIncidentModal').style.display = 'none';
                    loadIncidents();
                    showToast('Incidencia actualizada correctamente', 'success');
                } else {
                    showToast('Error: ' + result.message, 'error');
                }
            } catch (e) {
                console.error(e);
                showToast('Error al actualizar', 'error');
            }
        }

        async function loadBranches() {
            try {
                const res = await fetch(`${API_BASE_URL}/branches`);
                const data = await res.json();
                if (data.success) {
                    // Poblar el datalist para el modal de agregar (permite escribir manualmente)
                    const datalist = document.getElementById('branchDatalist');
                    if (datalist) {
                        datalist.innerHTML = '';
                        data.data.forEach(b => {
                            datalist.innerHTML += `<option value="${b.name}" data-id="${b.id}">`;
                        });
                    }
                }
            } catch (e) { console.error('Error loading branches', e); }
        }

        function openAddModal() {
            document.getElementById('addModal').style.display = 'flex';
        }

        async function saveEmployee() {
            const name = document.getElementById('newEmpName').value;
            const branchInput = document.getElementById('newEmpBranch').value.trim();
            const date = document.getElementById('newEmpDate').value;

            if (!name || !branchInput) {
                showToast('Nombre y Sucursal son obligatorios', 'warning');
                return;
            }

            try {
                // Verificar si la sucursal existe en el datalist
                const datalist = document.getElementById('branchDatalist');
                const options = datalist.querySelectorAll('option');
                let branchId = null;
                let branchName = branchInput;

                // Buscar si coincide con una sucursal existente
                for (let option of options) {
                    if (option.value === branchInput) {
                        branchId = option.getAttribute('data-id');
                        break;
                    }
                }

                // Si no existe, crear nueva sucursal primero
                if (!branchId) {
                    const branchRes = await fetch(`${API_BASE_URL}/branches`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ name: branchName })
                    });
                    const branchResult = await branchRes.json();
                    if (branchResult.success) {
                        branchId = branchResult.data.id;
                    } else {
                        showToast('Error al crear la sucursal: ' + branchResult.message, 'error');
                        return;
                    }
                }

                // Ahora crear el empleado con el branch_id
                const res = await fetch(`${API_BASE_URL}/employees`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ full_name: name, branch_id: branchId, hire_date: date })
                });
                const result = await res.json();
                if (result.success) {
                    showToast('Colaborador agregado correctamente', 'success');
                    document.getElementById('addModal').style.display = 'none';
                    // Limpiar el formulario
                    document.getElementById('newEmpName').value = '';
                    document.getElementById('newEmpBranch').value = '';
                    document.getElementById('newEmpDate').value = '';
                    loadJefesOficina(); // Reload table
                } else {
                    showToast('Error: ' + result.message, 'error');
                }
            } catch (e) {
                console.error('Error al guardar:', e);
                showToast('Error al guardar', 'error');
            }
        }

        async function deleteEmployee(id, name) {
            showConfirmToast(`¬øEst√°s seguro de que deseas eliminar a ${name}?`, async () => {
                try {
                    const res = await fetch(`${API_BASE_URL}/employees/${id}`, { method: 'DELETE' });
                    const result = await res.json();
                    if (result.success) {
                        loadJefesOficina(); // Reload table
                        showToast(`${name} eliminado correctamente`, 'success');
                    } else {
                        showToast('Error al eliminar', 'error');
                    }
                } catch (e) {
                    showToast('Error de conexi√≥n', 'error');
                }
            });
        }

        // --- EDIT EMPLOYEE LOGIC ---
        function openEditModal(id, name, branchId, date) {
            document.getElementById('editEmpId').value = id;
            document.getElementById('editEmpName').value = name;
            document.getElementById('editEmpDate').value = date;

            // Populate branch select
            const select = document.getElementById('editEmpBranch');
            select.innerHTML = '<option value="">Cargando...</option>';

            fetch(`${API_BASE_URL}/branches`)
                .then(res => res.json())
                .then(data => {
                    if (data.success) {
                        select.innerHTML = '<option value="">Selecciona sucursal</option>';
                        data.data.forEach(b => {
                            const selected = b.id == branchId ? 'selected' : '';
                            select.innerHTML += `<option value="${b.id}" ${selected}>${b.name}</option>`;
                        });
                    }
                })
                .catch(e => console.error(e));

            document.getElementById('editModal').style.display = 'flex';
        }

        async function saveEditedEmployee() {
            const id = document.getElementById('editEmpId').value;
            const name = document.getElementById('editEmpName').value;
            const branch = document.getElementById('editEmpBranch').value;
            const date = document.getElementById('editEmpDate').value;

            if (!name || !branch) {
                showToast('Nombre y Sucursal son obligatorios', 'warning');
                return;
            }

            try {
                const res = await fetch(`${API_BASE_URL}/employees/${id}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ full_name: name, branch_id: branch, hire_date: date })
                });
                const result = await res.json();
                if (result.success) {
                    showToast('Colaborador actualizado correctamente', 'success');
                    document.getElementById('editModal').style.display = 'none';
                    loadJefesOficina(); // Reload table
                } else {
                    showToast('Error: ' + result.message, 'error');
                }
            } catch (e) {
                showToast('Error al actualizar', 'error');
            }
        }

        // ==================== ADMIN REPORTS FUNCTIONS ====================

        async function openTutorReportModal() {
            const userStr = sessionStorage.getItem('user');
            const user = userStr ? JSON.parse(userStr) : null;

            if (!user) return;

            // Fetch supervised tutors
            const res = await fetch(`${API_BASE_URL}/supervised-tutors?userId=${user.id}`);
            const result = await res.json();

            const tutors = result.success ? result.tutors : [];

            // Create modal
            const modal = document.createElement('div');
            modal.id = 'tutorReportModal';
            modal.style.cssText = 'display: flex; position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background: rgba(0,0,0,0.6); justify-content: center; align-items: center; z-index: 10000;';

            const today = new Date();
            const currentMonth = today.getMonth();
            const currentYear = today.getFullYear();

            modal.innerHTML = `
                <div style="background: white; padding: 2rem; border-radius: 16px; width: 500px; max-width: 90%; box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                        <h3 style="margin: 0; color: #1e293b;">üìä Reporte de Tutores</h3>
                        <button onclick="closeTutorReportModal()" style="background: none; border: none; font-size: 1.5rem; cursor: pointer; color: #64748b;">&times;</button>
                    </div>

                    <div style="margin-bottom: 1.5rem;">
                        <label style="display: block; margin-bottom: 0.5rem; font-size: 0.9rem; color: #64748b; font-weight: 500;">Mes</label>
                        <select id="tutorReportMonth" style="width: 100%; padding: 0.8rem; border: 1px solid #cbd5e1; border-radius: 8px; font-family: inherit;">
                            ${monthNames.map((name, idx) => `<option value="${idx}" ${idx === currentMonth ? 'selected' : ''}>${name}</option>`).join('')}
                        </select>
                    </div>

                    <div style="margin-bottom: 1.5rem;">
                        <label style="display: block; margin-bottom: 0.5rem; font-size: 0.9rem; color: #64748b; font-weight: 500;">A√±o</label>
                        <select id="tutorReportYear" style="width: 100%; padding: 0.8rem; border: 1px solid #cbd5e1; border-radius: 8px; font-family: inherit;">
                            ${[currentYear, currentYear - 1, currentYear - 2].map(y => `<option value="${y}" ${y === currentYear ? 'selected' : ''}>${y}</option>`).join('')}
                        </select>
                    </div>

                    <div style="margin-bottom: 1.5rem;">
                        <label style="display: block; margin-bottom: 0.5rem; font-size: 0.9rem; color: #64748b; font-weight: 500;">Tutor</label>
                        <select id="tutorReportTutor" style="width: 100%; padding: 0.8rem; border: 1px solid #cbd5e1; border-radius: 8px; font-family: inherit;">
                            <option value="all">Todos los tutores</option>
                            ${tutors.map(t => `<option value="${t.id}">${t.username}</option>`).join('')}
                        </select>
                    </div>

                    <div style="display: flex; gap: 1rem; justify-content: flex-end;">
                        <button onclick="closeTutorReportModal()" style="padding: 0.8rem 1.5rem; border: 1px solid #cbd5e1; background: white; border-radius: 8px; cursor: pointer; font-family: inherit;">Cancelar</button>
                        <button onclick="generateTutorReport()" class="btn-primary" style="width: auto; padding: 0.8rem 1.5rem;">Generar Reporte</button>
                    </div>
                </div>
            `;

            document.body.appendChild(modal);
        }

        function closeTutorReportModal() {
            const modal = document.getElementById('tutorReportModal');
            if (modal) modal.remove();
        }

        async function generateTutorReport() {
            const userStr = sessionStorage.getItem('user');
            const user = userStr ? JSON.parse(userStr) : null;

            if (!user) return;

            const month = document.getElementById('tutorReportMonth').value;
            const year = document.getElementById('tutorReportYear').value;
            const tutorId = document.getElementById('tutorReportTutor').value;

            showToast('Generando reporte...', 'info');

            try {
                const url = `${API_BASE_URL}/reports/tutors?userId=${user.id}&month=${month}&year=${year}&tutorId=${tutorId}`;

                // Download file
                const link = document.createElement('a');
                link.href = url;
                link.download = `reporte_tutores_${parseInt(month) + 1}_${year}.xlsx`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);

                showToast('Reporte generado correctamente', 'success');
                closeTutorReportModal();
            } catch (e) {
                console.error(e);
                showToast('Error al generar reporte', 'error');
            }
        }

        async function openCollaboratorReportModal() {
            const userStr = sessionStorage.getItem('user');
            const user = userStr ? JSON.parse(userStr) : null;

            if (!user) return;

            // Fetch all collaborators from supervised tutors
            const res = await fetch(`${API_BASE_URL}/attendance?userId=${user.id}`);
            const result = await res.json();

            const collaborators = result.success ? result.data : [];

            // Create modal
            const modal = document.createElement('div');
            modal.id = 'collaboratorReportModal';
            modal.style.cssText = 'display: flex; position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background: rgba(0,0,0,0.6); justify-content: center; align-items: center; z-index: 10000;';

            const today = new Date();
            const currentMonth = today.getMonth();
            const currentYear = today.getFullYear();

            modal.innerHTML = `
                <div style="background: white; padding: 2rem; border-radius: 16px; width: 500px; max-width: 90%; box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                        <h3 style="margin: 0; color: #1e293b;">üìä Reporte de Colaboradores</h3>
                        <button onclick="closeCollaboratorReportModal()" style="background: none; border: none; font-size: 1.5rem; cursor: pointer; color: #64748b;">&times;</button>
                    </div>

                    <div style="margin-bottom: 1.5rem;">
                        <label style="display: block; margin-bottom: 0.5rem; font-size: 0.9rem; color: #64748b; font-weight: 500;">Mes</label>
                        <select id="collaboratorReportMonth" style="width: 100%; padding: 0.8rem; border: 1px solid #cbd5e1; border-radius: 8px; font-family: inherit;">
                            ${monthNames.map((name, idx) => `<option value="${idx}" ${idx === currentMonth ? 'selected' : ''}>${name}</option>`).join('')}
                        </select>
                    </div>

                    <div style="margin-bottom: 1.5rem;">
                        <label style="display: block; margin-bottom: 0.5rem; font-size: 0.9rem; color: #64748b; font-weight: 500;">A√±o</label>
                        <select id="collaboratorReportYear" style="width: 100%; padding: 0.8rem; border: 1px solid #cbd5e1; border-radius: 8px; font-family: inherit;">
                            ${[currentYear, currentYear - 1, currentYear - 2].map(y => `<option value="${y}" ${y === currentYear ? 'selected' : ''}>${y}</option>`).join('')}
                        </select>
                    </div>

                    <div style="margin-bottom: 1.5rem;">
                        <label style="display: block; margin-bottom: 0.5rem; font-size: 0.9rem; color: #64748b; font-weight: 500;">Colaborador</label>
                        <select id="collaboratorReportCollaborator" style="width: 100%; padding: 0.8rem; border: 1px solid #cbd5e1; border-radius: 8px; font-family: inherit;">
                            <option value="all">Todos los colaboradores</option>
                            ${collaborators.map(c => `<option value="${c.id}">${c.full_name}</option>`).join('')}
                        </select>
                    </div>

                    <div style="display: flex; gap: 1rem; justify-content: flex-end;">
                        <button onclick="closeCollaboratorReportModal()" style="padding: 0.8rem 1.5rem; border: 1px solid #cbd5e1; background: white; border-radius: 8px; cursor: pointer; font-family: inherit;">Cancelar</button>
                        <button onclick="generateCollaboratorReport()" class="btn-primary" style="width: auto; padding: 0.8rem 1.5rem;">Generar Reporte</button>
                    </div>
                </div>
            `;

            document.body.appendChild(modal);
        }

        function closeCollaboratorReportModal() {
            const modal = document.getElementById('collaboratorReportModal');
            if (modal) modal.remove();
        }

        async function generateCollaboratorReport() {
            const userStr = sessionStorage.getItem('user');
            const user = userStr ? JSON.parse(userStr) : null;

            if (!user) return;

            const month = document.getElementById('collaboratorReportMonth').value;
            const year = document.getElementById('collaboratorReportYear').value;
            const collaboratorId = document.getElementById('collaboratorReportCollaborator').value;

            showToast('Generando reporte...', 'info');

            try {
                const url = `${API_BASE_URL}/reports/collaborators?userId=${user.id}&month=${month}&year=${year}&collaboratorId=${collaboratorId}`;

                // Download file
                const link = document.createElement('a');
                link.href = url;
                link.download = `reporte_colaboradores_${parseInt(month) + 1}_${year}.xlsx`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);

                showToast('Reporte generado correctamente', 'success');
                closeCollaboratorReportModal();
            } catch (e) {
                console.error(e);
                showToast('Error al generar reporte', 'error');
            }
        }

        // ==================== REPORTES ESPEC√çFICOS ====================

        async function openAbsencesReportModal() {
            const userStr = sessionStorage.getItem('user');
            const user = userStr ? JSON.parse(userStr) : null;

            if (!user) return;

            // Fetch collaborators
            const res = await fetch(`${API_BASE_URL}/attendance?userId=${user.id}`);
            const result = await res.json();
            const collaborators = result.success ? result.data : [];

            const modal = document.createElement('div');
            modal.id = 'absencesReportModal';
            modal.style.cssText = 'display: flex; position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background: rgba(0,0,0,0.6); justify-content: center; align-items: center; z-index: 10000;';

            const today = new Date();
            const currentMonth = today.getMonth();
            const currentYear = today.getFullYear();

            modal.innerHTML = `
                <div style="background: white; padding: 2rem; border-radius: 16px; width: 500px; max-width: 90%; box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                        <h3 style="margin: 0; color: #1e293b;">‚ùå Reporte de Faltas</h3>
                        <button onclick="closeAbsencesReportModal()" style="background: none; border: none; font-size: 1.5rem; cursor: pointer; color: #64748b;">&times;</button>
                    </div>

                    <div style="margin-bottom: 1.5rem;">
                        <label style="display: block; margin-bottom: 0.5rem; font-size: 0.9rem; color: #64748b; font-weight: 500;">Mes</label>
                        <select id="absencesReportMonth" style="width: 100%; padding: 0.8rem; border: 1px solid #cbd5e1; border-radius: 8px; font-family: inherit;">
                            ${monthNames.map((name, idx) => `<option value="${idx}" ${idx === currentMonth ? 'selected' : ''}>${name}</option>`).join('')}
                        </select>
                    </div>

                    <div style="margin-bottom: 1.5rem;">
                        <label style="display: block; margin-bottom: 0.5rem; font-size: 0.9rem; color: #64748b; font-weight: 500;">A√±o</label>
                        <select id="absencesReportYear" style="width: 100%; padding: 0.8rem; border: 1px solid #cbd5e1; border-radius: 8px; font-family: inherit;">
                            ${[currentYear, currentYear - 1, currentYear - 2].map(y => `<option value="${y}" ${y === currentYear ? 'selected' : ''}>${y}</option>`).join('')}
                        </select>
                    </div>

                    <div style="margin-bottom: 1.5rem;">
                        <label style="display: block; margin-bottom: 0.5rem; font-size: 0.9rem; color: #64748b; font-weight: 500;">Colaborador</label>
                        <select id="absencesReportCollaborator" style="width: 100%; padding: 0.8rem; border: 1px solid #cbd5e1; border-radius: 8px; font-family: inherit;">
                            <option value="all">Todos los colaboradores</option>
                            ${collaborators.map(c => `<option value="${c.id}">${c.full_name}</option>`).join('')}
                        </select>
                    </div>

                    <div style="display: flex; gap: 1rem; justify-content: flex-end;">
                        <button onclick="closeAbsencesReportModal()" style="padding: 0.8rem 1.5rem; border: 1px solid #cbd5e1; background: white; border-radius: 8px; cursor: pointer; font-family: inherit;">Cancelar</button>
                        <button onclick="generateAbsencesReport()" class="btn-primary" style="width: auto; padding: 0.8rem 1.5rem;">Generar Reporte</button>
                    </div>
                </div>
            `;

            document.body.appendChild(modal);
        }

        function closeAbsencesReportModal() {
            const modal = document.getElementById('absencesReportModal');
            if (modal) modal.remove();
        }

        async function generateAbsencesReport() {
            const userStr = sessionStorage.getItem('user');
            const user = userStr ? JSON.parse(userStr) : null;

            if (!user) return;

            const month = document.getElementById('absencesReportMonth').value;
            const year = document.getElementById('absencesReportYear').value;
            const collaboratorId = document.getElementById('absencesReportCollaborator').value;

            showToast('Generando reporte...', 'info');

            try {
                const url = `${API_BASE_URL}/reports/absences?userId=${user.id}&month=${month}&year=${year}&collaboratorId=${collaboratorId}`;

                const link = document.createElement('a');
                link.href = url;
                link.download = `reporte_faltas_${parseInt(month) + 1}_${year}.xlsx`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);

                showToast('Reporte generado correctamente', 'success');
                closeAbsencesReportModal();
            } catch (e) {
                console.error(e);
                showToast('Error al generar reporte', 'error');
            }
        }

        async function openVacationsReportModal() {
            const userStr = sessionStorage.getItem('user');
            const user = userStr ? JSON.parse(userStr) : null;

            if (!user) return;

            // Fetch collaborators
            const res = await fetch(`${API_BASE_URL}/attendance?userId=${user.id}`);
            const result = await res.json();
            const collaborators = result.success ? result.data : [];

            const modal = document.createElement('div');
            modal.id = 'vacationsReportModal';
            modal.style.cssText = 'display: flex; position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background: rgba(0,0,0,0.6); justify-content: center; align-items: center; z-index: 10000;';

            const today = new Date();
            const currentMonth = today.getMonth();
            const currentYear = today.getFullYear();

            modal.innerHTML = `
                <div style="background: white; padding: 2rem; border-radius: 16px; width: 500px; max-width: 90%; box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                        <h3 style="margin: 0; color: #1e293b;">üèñÔ∏è Reporte de Vacaciones</h3>
                        <button onclick="closeVacationsReportModal()" style="background: none; border: none; font-size: 1.5rem; cursor: pointer; color: #64748b;">&times;</button>
                    </div>

                    <div style="margin-bottom: 1.5rem;">
                        <label style="display: block; margin-bottom: 0.5rem; font-size: 0.9rem; color: #64748b; font-weight: 500;">Mes</label>
                        <select id="vacationsReportMonth" style="width: 100%; padding: 0.8rem; border: 1px solid #cbd5e1; border-radius: 8px; font-family: inherit;">
                            ${monthNames.map((name, idx) => `<option value="${idx}" ${idx === currentMonth ? 'selected' : ''}>${name}</option>`).join('')}
                        </select>
                    </div>

                    <div style="margin-bottom: 1.5rem;">
                        <label style="display: block; margin-bottom: 0.5rem; font-size: 0.9rem; color: #64748b; font-weight: 500;">A√±o</label>
                        <select id="vacationsReportYear" style="width: 100%; padding: 0.8rem; border: 1px solid #cbd5e1; border-radius: 8px; font-family: inherit;">
                            ${[currentYear, currentYear - 1, currentYear - 2].map(y => `<option value="${y}" ${y === currentYear ? 'selected' : ''}>${y}</option>`).join('')}
                        </select>
                    </div>

                    <div style="margin-bottom: 1.5rem;">
                        <label style="display: block; margin-bottom: 0.5rem; font-size: 0.9rem; color: #64748b; font-weight: 500;">Colaborador</label>
                        <select id="vacationsReportCollaborator" style="width: 100%; padding: 0.8rem; border: 1px solid #cbd5e1; border-radius: 8px; font-family: inherit;">
                            <option value="all">Todos los colaboradores</option>
                            ${collaborators.map(c => `<option value="${c.id}">${c.full_name}</option>`).join('')}
                        </select>
                    </div>

                    <div style="display: flex; gap: 1rem; justify-content: flex-end;">
                        <button onclick="closeVacationsReportModal()" style="padding: 0.8rem 1.5rem; border: 1px solid #cbd5e1; background: white; border-radius: 8px; cursor: pointer; font-family: inherit;">Cancelar</button>
                        <button onclick="generateVacationsReport()" class="btn-primary" style="width: auto; padding: 0.8rem 1.5rem;">Generar Reporte</button>
                    </div>
                </div>
            `;

            document.body.appendChild(modal);
        }

        function closeVacationsReportModal() {
            const modal = document.getElementById('vacationsReportModal');
            if (modal) modal.remove();
        }

        async function generateVacationsReport() {
            const userStr = sessionStorage.getItem('user');
            const user = userStr ? JSON.parse(userStr) : null;

            if (!user) return;

            const month = document.getElementById('vacationsReportMonth').value;
            const year = document.getElementById('vacationsReportYear').value;
            const collaboratorId = document.getElementById('vacationsReportCollaborator').value;

            showToast('Generando reporte...', 'info');

            try {
                const url = `${API_BASE_URL}/reports/vacations?userId=${user.id}&month=${month}&year=${year}&collaboratorId=${collaboratorId}`;

                const link = document.createElement('a');
                link.href = url;
                link.download = `reporte_vacaciones_${parseInt(month) + 1}_${year}.xlsx`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);

                showToast('Reporte generado correctamente', 'success');
                closeVacationsReportModal();
            } catch (e) {
                console.error(e);
                showToast('Error al generar reporte', 'error');
            }
        }

        async function openIncidentsReportModal() {
            const userStr = sessionStorage.getItem('user');
            const user = userStr ? JSON.parse(userStr) : null;

            if (!user) return;

            // Fetch branches
            const res = await fetch(`${API_BASE_URL}/branches`);
            const result = await res.json();
            const branches = result.success ? result.data : [];

            const modal = document.createElement('div');
            modal.id = 'incidentsReportModal';
            modal.style.cssText = 'display: flex; position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background: rgba(0,0,0,0.6); justify-content: center; align-items: center; z-index: 10000;';

            const today = new Date();
            const currentMonth = today.getMonth();
            const currentYear = today.getFullYear();

            modal.innerHTML = `
                <div style="background: white; padding: 2rem; border-radius: 16px; width: 500px; max-width: 90%; box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                        <h3 style="margin: 0; color: #1e293b;">‚ö†Ô∏è Reporte de Incidencias</h3>
                        <button onclick="closeIncidentsReportModal()" style="background: none; border: none; font-size: 1.5rem; cursor: pointer; color: #64748b;">&times;</button>
                    </div>

                    <div style="margin-bottom: 1.5rem;">
                        <label style="display: block; margin-bottom: 0.5rem; font-size: 0.9rem; color: #64748b; font-weight: 500;">Mes</label>
                        <select id="incidentsReportMonth" style="width: 100%; padding: 0.8rem; border: 1px solid #cbd5e1; border-radius: 8px; font-family: inherit;">
                            ${monthNames.map((name, idx) => `<option value="${idx}" ${idx === currentMonth ? 'selected' : ''}>${name}</option>`).join('')}
                        </select>
                    </div>

                    <div style="margin-bottom: 1.5rem;">
                        <label style="display: block; margin-bottom: 0.5rem; font-size: 0.9rem; color: #64748b; font-weight: 500;">A√±o</label>
                        <select id="incidentsReportYear" style="width: 100%; padding: 0.8rem; border: 1px solid #cbd5e1; border-radius: 8px; font-family: inherit;">
                            ${[currentYear, currentYear - 1, currentYear - 2].map(y => `<option value="${y}" ${y === currentYear ? 'selected' : ''}>${y}</option>`).join('')}
                        </select>
                    </div>

                    <div style="margin-bottom: 1.5rem;">
                        <label style="display: block; margin-bottom: 0.5rem; font-size: 0.9rem; color: #64748b; font-weight: 500;">Sucursal</label>
                        <select id="incidentsReportBranch" style="width: 100%; padding: 0.8rem; border: 1px solid #cbd5e1; border-radius: 8px; font-family: inherit;">
                            <option value="all">Todas las sucursales</option>
                            ${branches.map(b => `<option value="${b.id}">${b.name}</option>`).join('')}
                        </select>
                    </div>

                    <div style="display: flex; gap: 1rem; justify-content: flex-end;">
                        <button onclick="closeIncidentsReportModal()" style="padding: 0.8rem 1.5rem; border: 1px solid #cbd5e1; background: white; border-radius: 8px; cursor: pointer; font-family: inherit;">Cancelar</button>
                        <button onclick="generateIncidentsReport()" class="btn-primary" style="width: auto; padding: 0.8rem 1.5rem;">Generar Reporte</button>
                    </div>
                </div>
            `;

            document.body.appendChild(modal);
        }

        function closeIncidentsReportModal() {
            const modal = document.getElementById('incidentsReportModal');
            if (modal) modal.remove();
        }

        async function generateIncidentsReport() {
            const userStr = sessionStorage.getItem('user');
            const user = userStr ? JSON.parse(userStr) : null;

            if (!user) return;

            const month = document.getElementById('incidentsReportMonth').value;
            const year = document.getElementById('incidentsReportYear').value;
            const branchId = document.getElementById('incidentsReportBranch').value;

            showToast('Generando reporte...', 'info');

            try {
                const url = `${API_BASE_URL}/reports/incidents?userId=${user.id}&month=${month}&year=${year}&branchId=${branchId}`;

                const link = document.createElement('a');
                link.href = url;
                link.download = `reporte_incidencias_${parseInt(month) + 1}_${year}.xlsx`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);

                showToast('Reporte generado correctamente', 'success');
                closeIncidentsReportModal();
            } catch (e) {
                console.error(e);
                showToast('Error al generar reporte', 'error');
            }
        }

        // ==================== BRANCH CHANGES (ROTACI√ìN DE PERSONAL) ====================

        let branchChangesPollingInterval = null;
        let lastBranchChangesCount = 0;
        const rotationSound = new Audio('death.mp3');

        // Iniciar polling de cambios en sucursales
        function startBranchChangesPolling() {
            // Poll cada 30 segundos
            branchChangesPollingInterval = setInterval(checkBranchChanges, 30000);
            // Verificar inmediatamente
            checkBranchChanges();
        }

        // Verificar cambios en sucursales
        async function checkBranchChanges() {
            try {
                const userStr = sessionStorage.getItem('user');
                const user = userStr ? JSON.parse(userStr) : null;

                if (!user) return;

                const response = await fetch(`${API_BASE_URL}/branch-changes?userId=${user.id}`);

                if (!response.ok) return;

                const result = await response.json();

                if (result.success) {
                    const changes = result.data || [];
                    const count = changes.length;

                    // Actualizar badge
                    const badge = document.getElementById('rotationBadge');
                    if (badge) {
                        if (count > 0) {
                            badge.textContent = count;
                            badge.style.display = 'flex';

                            // Si hay nuevos cambios, reproducir sonido
                            if (count > lastBranchChangesCount && lastBranchChangesCount > 0) {
                                rotationSound.play().catch(e => console.log('No se pudo reproducir el sonido'));
                            }
                        } else {
                            badge.style.display = 'none';
                        }
                    }

                    lastBranchChangesCount = count;
                }
            } catch (error) {
                console.error('Error checking branch changes:', error);
            }
        }

        // Abrir panel de cambios en sucursales
        async function openBranchChangesPanel() {
            try {
                const userStr = sessionStorage.getItem('user');
                const user = userStr ? JSON.parse(userStr) : null;

                if (!user) return;

                // Crear modal si no existe
                if (!document.getElementById('branchChangesModal')) {
                    document.body.insertAdjacentHTML('beforeend', `
                        <div id="branchChangesModal" style="display: none; position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background: rgba(0,0,0,0.5); justify-content: center; align-items: center; z-index: 10002;">
                            <div style="background: white; padding: 2rem; border-radius: 12px; width: 700px; max-width: 90%; max-height: 90vh; display: flex; flex-direction: column;">
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; padding-bottom: 1rem; border-bottom: 2px solid #f59e0b;">
                                    <h3 style="margin: 0; color: #1e293b; display: flex; align-items: center; gap: 0.5rem;">
                                        <img src="rotacion.png" alt="Rotaci√≥n" style="height: 24px; width: auto;">
                                        Cambios en sucursales
                                    </h3>
                                    <button onclick="closeBranchChangesPanel()" style="background: none; border: none; font-size: 1.5rem; cursor: pointer; color: #64748b;">&times;</button>
                                </div>
                                
                                <div id="branchChangesList" style="overflow-y: auto; flex: 1; max-height: 500px;">
                                    <p style="text-align: center; color: #94a3b8; padding: 1rem;">Cargando...</p>
                                </div>
                                
                                <div style="margin-top: 1rem; text-align: right;">
                                    <button onclick="closeBranchChangesPanel()" style="padding: 0.6rem 1.2rem; background: #f1f5f9; color: #475569; border: none; border-radius: 6px; cursor: pointer;">Cerrar</button>
                                </div>
                            </div>
                        </div>
                    `);
                }

                // Mostrar modal
                document.getElementById('branchChangesModal').style.display = 'flex';

                // Cargar cambios
                const response = await fetch(`${API_BASE_URL}/branch-changes?userId=${user.id}`);
                const result = await response.json();

                if (result.success) {
                    renderBranchChanges(result.data || []);
                } else {
                    document.getElementById('branchChangesList').innerHTML = '<p style="text-align: center; color: #ef4444; padding: 1rem;">Error al cargar cambios</p>';
                }
            } catch (error) {
                console.error('Error opening branch changes panel:', error);
                document.getElementById('branchChangesList').innerHTML = '<p style="text-align: center; color: #ef4444; padding: 1rem;">Error de conexi√≥n</p>';
            }
        }

        // Cerrar panel
        function closeBranchChangesPanel() {
            document.getElementById('branchChangesModal').style.display = 'none';
        }

        // Renderizar lista de cambios
        function renderBranchChanges(changes) {
            const container = document.getElementById('branchChangesList');

            if (changes.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #94a3b8; padding: 2rem;">No hay cambios pendientes</p>';
                return;
            }

            let html = '<div style="display: flex; flex-direction: column; gap: 0.75rem;">';

            changes.forEach(change => {
                const isIngreso = change.change_type === 'ingreso';
                const bgColor = isIngreso ? '#d1fae5' : '#fee2e2';
                const textColor = isIngreso ? '#065f46' : '#991b1b';
                const icon = isIngreso ? '‚úì' : '‚úó';

                html += `
                    <div style="background: white; border: 1px solid #e2e8f0; border-radius: 8px; padding: 1rem; position: relative; border-left: 4px solid ${isIngreso ? '#10b981' : '#ef4444'};">
                        <div style="display: flex; justify-content: space-between; align-items: start; gap: 1rem;">
                            <div style="flex: 1;">
                                <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem;">
                                    <span style="background: ${bgColor}; color: ${textColor}; padding: 0.25rem 0.75rem; border-radius: 12px; font-size: 0.75rem; font-weight: 600;">
                                        ${icon} ${isIngreso ? 'INGRESO' : 'EGRESO'}
                                    </span>
                                    <span style="color: #64748b; font-size: 0.75rem;">${change.created_at}</span>
                                </div>
                                
                                <div style="color: #1e293b; font-weight: 500; margin-bottom: 0.25rem;">
                                    ${change.branch_name || 'Sucursal desconocida'}
                                </div>
                                
                                ${change.description ? `
                                    <div style="color: #64748b; font-size: 0.9rem; margin-top: 0.5rem; padding: 0.5rem; background: #f8fafc; border-radius: 4px;">
                                        ${change.description}
                                    </div>
                                ` : ''}
                                
                                ${change.employee_name ? `
                                    <div style="color: #475569; font-size: 0.85rem; margin-top: 0.5rem;">
                                        <strong>Colaborador:</strong> ${change.employee_name}
                                        ${change.hire_date ? ` | <strong>Fecha:</strong> ${change.hire_date}` : ''}
                                    </div>
                                ` : ''}
                            </div>
                            
                            <button onclick="processBranchChange(${change.id})" 
                                    style="background: #ef4444; color: white; border: none; width: 28px; height: 28px; border-radius: 50%; cursor: pointer; font-size: 1.2rem; display: flex; align-items: center; justify-content: center; flex-shrink: 0; transition: background 0.2s;"
                                    onmouseover="this.style.background='#dc2626'"
                                    onmouseout="this.style.background='#ef4444'"
                                    title="Marcar como procesado">
                                √ó
                            </button>
                        </div>
                    </div>
                `;
            });

            html += '</div>';
            container.innerHTML = html;
        }

        // Procesar (eliminar) un cambio
        async function processBranchChange(changeId) {
            try {
                const userStr = sessionStorage.getItem('user');
                const user = userStr ? JSON.parse(userStr) : null;

                if (!user) return;

                const response = await fetch(`${API_BASE_URL}/branch-changes/${changeId}`, {
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ userId: user.id })
                });

                const result = await response.json();

                if (result.success) {
                    showToast('Cambio procesado correctamente', 'success');
                    // Recargar lista
                    openBranchChangesPanel();
                    // Actualizar contador
                    checkBranchChanges();
                } else {
                    showToast('Error al procesar cambio', 'error');
                }
            } catch (error) {
                console.error('Error processing branch change:', error);
                showToast('Error de conexi√≥n', 'error');
            }
        }
    </script>
    <!-- STATIC MODAL OUTSIDE OF DASHBOARD CONTAINER -->
    <div id="addModal"
        style="display: none; position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background: rgba(0,0,0,0.6); justify-content: center; align-items: center; z-index: 9999;">
        <div
            style="background: white; padding: 2rem; border-radius: 16px; width: 400px; max-width: 90%; box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);">
            <h3 style="margin-bottom: 1.5rem; color: #1e293b;">Nuevo Jefe de Oficina</h3>

            <div style="margin-bottom: 1rem;">
                <label style="display: block; margin-bottom: 0.5rem; font-size: 0.9rem; color: #64748b;">Nombre
                    Completo</label>
                <input type="text" id="newEmpName"
                    style="width: 100%; padding: 0.8rem; border: 1px solid #cbd5e1; border-radius: 8px; font-family: inherit;">
            </div>

            <div style="margin-bottom: 1rem;">
                <label
                    style="display: block; margin-bottom: 0.5rem; font-size: 0.9rem; color: #64748b;">Sucursal</label>
                <input type="text" id="newEmpBranch" list="branchDatalist"
                    placeholder="Selecciona o escribe una sucursal..."
                    style="width: 100%; padding: 0.8rem; border: 1px solid #cbd5e1; border-radius: 8px; font-family: inherit;">
                <datalist id="branchDatalist">
                    <!-- Las opciones se cargan din√°micamente -->
                </datalist>
                <small style="display: block; margin-top: 0.25rem; font-size: 0.8rem; color: #94a3b8;">Puedes
                    seleccionar de la lista o escribir una nueva sucursal</small>
            </div>

            <div style="margin-bottom: 1.5rem;">
                <label style="display: block; margin-bottom: 0.5rem; font-size: 0.9rem; color: #64748b;">Fecha
                    Ingreso</label>
                <input type="date" id="newEmpDate"
                    style="width: 100%; padding: 0.8rem; border: 1px solid #cbd5e1; border-radius: 8px; font-family: inherit;">
            </div>

            <div style="display: flex; gap: 1rem; justify-content: flex-end;">
                <button onclick="document.getElementById('addModal').style.display='none'"
                    style="padding: 0.8rem 1.5rem; border: 1px solid #cbd5e1; background: white; border-radius: 8px; cursor: pointer; font-family: inherit;">Cancelar</button>
                <button onclick="saveEmployee()" class="btn-primary"
                    style="width: auto; padding: 0.8rem 1.5rem;">Guardar</button>
            </div>
        </div>
    </div>

    <!-- EDIT MODAL -->
    <div id="editModal"
        style="display: none; position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background: rgba(0,0,0,0.6); justify-content: center; align-items: center; z-index: 9999;">
        <div
            style="background: white; padding: 2rem; border-radius: 16px; width: 400px; max-width: 90%; box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);">
            <h3 style="margin-bottom: 1.5rem; color: #1e293b;">Editar Jefe de Oficina</h3>
            <input type="hidden" id="editEmpId">

            <div style="margin-bottom: 1rem;">
                <label style="display: block; margin-bottom: 0.5rem; font-size: 0.9rem; color: #64748b;">Nombre
                    Completo</label>
                <input type="text" id="editEmpName"
                    style="width: 100%; padding: 0.8rem; border: 1px solid #cbd5e1; border-radius: 8px; font-family: inherit;">
            </div>

            <div style="margin-bottom: 1rem;">
                <label
                    style="display: block; margin-bottom: 0.5rem; font-size: 0.9rem; color: #64748b;">Sucursal</label>
                <select id="editEmpBranch"
                    style="width: 100%; padding: 0.8rem; border: 1px solid #cbd5e1; border-radius: 8px; font-family: inherit;">
                    <option value="">Cargando...</option>
                </select>
            </div>

            <div style="margin-bottom: 1.5rem;">
                <label style="display: block; margin-bottom: 0.5rem; font-size: 0.9rem; color: #64748b;">Fecha
                    Ingreso</label>
                <input type="date" id="editEmpDate"
                    style="width: 100%; padding: 0.8rem; border: 1px solid #cbd5e1; border-radius: 8px; font-family: inherit;">
            </div>

            <div style="display: flex; gap: 1rem; justify-content: flex-end;">
                <button onclick="document.getElementById('editModal').style.display='none'"
                    style="padding: 0.8rem 1.5rem; border: 1px solid #cbd5e1; background: white; border-radius: 8px; cursor: pointer; font-family: inherit;">Cancelar</button>
                <button onclick="saveEditedEmployee()" class="btn-primary"
                    style="width: auto; padding: 0.8rem 1.5rem;">Guardar Cambios</button>
            </div>
        </div>
    </div>
    <!-- Roster Modal -->
    <div id="rosterModal"
        style="display: none; position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background: rgba(0,0,0,0.6); justify-content: center; align-items: center; z-index: 10001;">
        <div style="background: white; padding: 2rem; border-radius: 16px; width: 500px; max-width: 90%;">
            <h3>Agregar a la Lista</h3>
            <p style="margin-bottom: 1rem; color: #64748b;">Busca y selecciona un colaborador para llevar su asistencia.
            </p>
            <input type="text" id="rosterSearch" placeholder="Buscar por nombre..." onkeyup="filterRosterOptions()"
                style="width: 100%; padding: 0.8rem; border: 1px solid #cbd5e1; border-radius: 8px; margin-bottom: 1rem;">

            <div id="rosterList"
                style="max-height: 300px; overflow-y: auto; border: 1px solid #e2e8f0; border-radius: 8px; margin-bottom: 1rem;">
                <!-- Options populate here -->
            </div>

            <div style="text-align: right;">
                <button onclick="document.getElementById('rosterModal').style.display='none'"
                    style="padding: 0.8rem 1.5rem; border: 1px solid #cbd5e1; background: white; border-radius: 8px; cursor: pointer;">Cerrar</button>
            </div>
        </div>
    </div>

    <!-- Reports Module -->
    <script src="js/reports.js"></script>
</body>

</html>